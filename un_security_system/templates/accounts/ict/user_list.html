{% extends "base.html" %}
{% block title %}Agency Users{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">
        <i class="bi bi-people me-2"></i> Agency Users
      </h2>
      <p class="text-muted mb-0">
        <i class="bi bi-building me-1"></i>
        <span class="fw-semibold">{{ my_agency|default:"No Agency Assigned" }}</span>
      </p>
    </div>
    <a class="btn btn-primary" href="{% url 'accounts:ict_user_create' %}">
      <i class="bi bi-person-plus me-1"></i> Add New User
    </a>
  </div>

  <!-- Search and Filters -->
  <form method="get" class="card shadow-sm mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0"><i class="bi bi-funnel me-2"></i>Search & Filters</h6>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-8">
          <label for="search" class="form-label fw-semibold">
            <i class="bi bi-search me-1"></i>Search
          </label>
          <input type="text"
                 id="search"
                 name="q"
                 value="{{ q }}"
                 class="form-control"
                 placeholder="Search by username, name, or email address...">
        </div>
        <div class="col-md-4 d-flex align-items-end gap-2">
          <button type="submit" class="btn btn-primary flex-grow-1">
            <i class="bi bi-search me-1"></i> Search
          </button>
          <a href="?"
             class="btn btn-outline-secondary"
             title="Clear search">
            <i class="bi bi-x-circle"></i>
          </a>
        </div>
      </div>
    </div>
  </form>

  <!-- Results Card -->
  <div class="card shadow-sm">
    {% if users %}
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
          <i class="bi bi-list-ul me-2"></i>Users
          <span class="badge bg-secondary ms-2">{{ users|length }}</span>
        </h6>
        {% if q %}
          <small class="text-muted">
            <i class="bi bi-funnel me-1"></i>Filtered results for "{{ q }}"
          </small>
        {% endif %}
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:18%">Username</th>
              <th style="width:22%">Full Name</th>
              <th style="width:26%">Email Address</th>
              <th style="width:16%">Role</th>
              <th style="width:18%">Employee ID</th>
            </tr>
          </thead>
          <tbody>
            {% for u in users %}
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <i class="bi bi-person-circle me-2 text-muted"></i>
                  <span class="fw-semibold text-dark">{{ u.username }}</span>
                </div>
              </td>
              <td>
                <span class="fw-medium">{{ u.get_full_name|default:"—" }}</span>
                {% if not u.get_full_name %}
                  <small class="text-muted fst-italic">(No name set)</small>
                {% endif %}
              </td>
              <td>
                {% if u.email %}
                  <a href="mailto:{{ u.email }}" class="text-decoration-none">
                    <i class="bi bi-envelope me-1"></i>{{ u.email }}
                  </a>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if u.role %}
                  <span class="badge bg-primary">
                    <i class="bi bi-shield-check me-1"></i>{{ u.get_role_display }}
                  </span>
                {% else %}
                  <span class="badge bg-secondary">No Role</span>
                {% endif %}
              </td>
              <td>
                {% if u.employee_id %}
                  <span class="font-monospace text-dark">{{ u.employee_id }}</span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      {% if is_paginated %}
        <div class="card-footer bg-light">
          <nav aria-label="Page navigation">
            <ul class="pagination pagination-sm justify-content-center mb-0">
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link"
                     href="?page=1{% if q %}&q={{ q }}{% endif %}"
                     aria-label="First">
                    <i class="bi bi-chevron-double-left"></i>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link"
                     href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}"
                     aria-label="Previous">
                    <i class="bi bi-chevron-left"></i>
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link"><i class="bi bi-chevron-double-left"></i></span>
                </li>
                <li class="page-item disabled">
                  <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                </li>
              {% endif %}

              <li class="page-item disabled">
                <span class="page-link fw-semibold">
                  Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </span>
              </li>

              {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link"
                     href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}"
                     aria-label="Next">
                    <i class="bi bi-chevron-right"></i>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link"
                     href="?page={{ page_obj.paginator.num_pages }}{% if q %}&q={{ q }}{% endif %}"
                     aria-label="Last">
                    <i class="bi bi-chevron-double-right"></i>
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                </li>
                <li class="page-item disabled">
                  <span class="page-link"><i class="bi bi-chevron-double-right"></i></span>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% endif %}

    {% else %}
      <!-- Empty State -->
      <div class="card-body text-center py-5">
        <div class="mb-4">
          <i class="bi bi-people fs-1 text-muted"></i>
        </div>
        <h5 class="mb-2">No Users Found</h5>
        <p class="text-muted mb-4">
          {% if q %}
            No users match your search criteria for "<strong>{{ q }}</strong>".
          {% elif my_agency %}
            There are no users registered under {{ my_agency }}.
          {% else %}
            You are not assigned to an agency or there are no users in your agency.
          {% endif %}
        </p>
        <div class="d-flex gap-2 justify-content-center">
          {% if q %}
            <a href="{% url 'accounts:ict_agency_users' %}" class="btn btn-outline-primary">
              <i class="bi bi-x-circle me-1"></i> Clear Search
            </a>
          {% endif %}
          <a href="{% url 'accounts:ict_user_create' %}" class="btn btn-primary">
            <i class="bi bi-person-plus me-1"></i> Add First User
          </a>
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}