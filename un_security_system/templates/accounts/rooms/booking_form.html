{% extends "base.html" %}
{% block title %}Book Room{% endblock %}

{% block extra_css %}
<style>
    .booking-form-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .form-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 16px 16px 0 0;
        position: relative;
        overflow: hidden;
    }

    .form-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 400px;
        height: 400px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }

    .form-header h3 {
        position: relative;
        z-index: 1;
        margin: 0;
        font-weight: 700;
    }

    .form-header p {
        position: relative;
        z-index: 1;
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
    }

    .booking-form-card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 1rem 3rem rgba(0,0,0,0.175);
        overflow: hidden;
    }

    .form-section {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
    }

    .form-section-title {
        font-weight: 700;
        font-size: 0.9rem;
        color: #667eea;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-section-title i {
        font-size: 1.2rem;
    }

    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-label i {
        color: #667eea;
        font-size: 0.9rem;
    }

    .form-label .required {
        color: #dc3545;
        font-size: 0.9rem;
    }

    .form-control, .form-select {
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.75rem;
        transition: all 0.3s ease;
        font-size: 0.95rem;
    }

    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.15);
        transform: translateY(-1px);
    }

    .form-control:hover, .form-select:hover {
        border-color: #9ca3af;
    }

    textarea.form-control {
        min-height: 120px;
        resize: vertical;
    }

    .time-estimate {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid #f59e0b;
        border-radius: 12px;
        padding: 1rem;
        margin-top: 1rem;
        display: none;
    }

    .time-estimate.show {
        display: block;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .time-estimate-content {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .time-estimate-icon {
        font-size: 2rem;
    }

    .time-estimate-text {
        flex: 1;
    }

    .time-estimate-duration {
        font-size: 1.5rem;
        font-weight: 700;
        color: #92400e;
    }

    .quick-times {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
    }

    .quick-time-btn {
        padding: 0.4rem 0.8rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .quick-time-btn:hover {
        border-color: #667eea;
        background: #f0f4ff;
        transform: translateY(-1px);
    }

    .help-text {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 0.35rem;
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    .help-text i {
        font-size: 0.9rem;
    }

    /* Recurring Booking Styles */
    .recurring-toggle {
        background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
        border: 2px solid #667eea;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .recurring-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(102, 126, 234, 0.2);
    }

    .recurring-toggle-content {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .recurring-toggle-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }

    .recurring-toggle-text {
        flex: 1;
    }

    .recurring-toggle-title {
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.25rem;
        font-size: 1.1rem;
    }

    .recurring-toggle-desc {
        font-size: 0.9rem;
        color: #6b7280;
        margin: 0;
    }

    .recurring-switch {
        width: 60px;
        height: 32px;
        position: relative;
    }

    .recurring-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .recurring-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #cbd5e1;
        transition: 0.4s;
        border-radius: 34px;
    }

    .recurring-slider:before {
        position: absolute;
        content: "";
        height: 24px;
        width: 24px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }

    input:checked + .recurring-slider {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    input:checked + .recurring-slider:before {
        transform: translateX(28px);
    }

    .recurring-options {
        display: none;
        animation: slideDown 0.3s ease;
    }

    .recurring-options.show {
        display: block;
    }

    .frequency-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
        margin-top: 0.5rem;
    }

    .frequency-option {
        position: relative;
    }

    .frequency-option input[type="radio"] {
        position: absolute;
        opacity: 0;
    }

    .frequency-option label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1rem 0.5rem;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        gap: 0.5rem;
        text-align: center;
    }

    .frequency-option label i {
        font-size: 1.5rem;
        color: #9ca3af;
        transition: all 0.3s;
    }

    .frequency-option label span {
        font-weight: 600;
        font-size: 0.9rem;
        color: #6b7280;
        transition: all 0.3s;
    }

    .frequency-option input:checked + label {
        border-color: #667eea;
        background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
    }

    .frequency-option input:checked + label i {
        color: #667eea;
    }

    .frequency-option input:checked + label span {
        color: #667eea;
    }

    .frequency-option label:hover {
        border-color: #667eea;
        transform: translateY(-2px);
    }

    .weekdays-selector {
        display: none;
        margin-top: 1rem;
    }

    .weekdays-selector.show {
        display: block;
        animation: slideDown 0.3s ease;
    }

    .weekdays-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .weekday-option {
        position: relative;
    }

    .weekday-option input[type="checkbox"] {
        position: absolute;
        opacity: 0;
    }

    .weekday-option label {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 0.25rem;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
        font-size: 0.85rem;
        color: #6b7280;
    }

    .weekday-option input:checked + label {
        border-color: #667eea;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .weekday-option label:hover {
        border-color: #667eea;
        transform: translateY(-1px);
    }

    .occurrence-preview {
        background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
        border: 2px solid #0ea5e9;
        border-radius: 12px;
        padding: 1rem;
        margin-top: 1rem;
        display: none;
    }

    .occurrence-preview.show {
        display: block;
        animation: slideDown 0.3s ease;
    }

    .occurrence-preview-content {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .occurrence-preview-icon {
        font-size: 2rem;
    }

    .occurrence-preview-text {
        flex: 1;
    }

    .occurrence-count {
        font-size: 1.5rem;
        font-weight: 700;
        color: #075985;
    }

    .form-footer {
        background: #f8f9fa;
        padding: 1.5rem 2rem;
        border-top: 2px solid #e5e7eb;
    }

    .btn-submit {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 0.75rem 2rem;
        font-weight: 600;
        border-radius: 10px;
        transition: all 0.3s;
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(102, 126, 234, 0.3);
    }

    .btn-cancel {
        background: #f3f4f6;
        color: #6b7280;
        border: 2px solid #e5e7eb;
        padding: 0.65rem 2rem;
        font-weight: 600;
        border-radius: 10px;
        transition: all 0.3s;
        text-decoration: none;
    }

    .btn-cancel:hover {
        background: #e5e7eb;
        color: #374151;
        transform: translateY(-2px);
    }

    .room-preview {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 1rem;
        margin-top: 0.5rem;
        display: none;
    }

    .room-preview.show {
        display: flex;
        animation: slideDown 0.3s ease;
    }

    .room-preview-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #667eea;
        font-size: 1.5rem;
        margin-right: 1rem;
    }

    .room-preview-details {
        flex: 1;
    }

    .room-preview-name {
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.25rem;
    }

    .room-preview-meta {
        font-size: 0.85rem;
        color: #6b7280;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="booking-form-container">
        <form method="post" class="booking-form-card" id="bookingForm">
            {% csrf_token %}
            {# Authoritative recurring flag ‚Äî set by JS when the toggle is on #}
            <input type="hidden" name="is_recurring" id="isRecurringInput" value="">

            <!-- Header -->
            <div class="form-header">
                <h3>
                    <i class="bi bi-calendar-check me-2"></i>
                    Book a Room
                </h3>
                <p>Reserve a meeting room for your upcoming session</p>
            </div>

            <!-- Form Body -->
            <div class="p-4">

                <!-- Room Selection -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="bi bi-door-open"></i>
                        Room Selection
                    </div>

                    <label class="form-label">
                        <i class="bi bi-geo-alt"></i>
                        Select Room
                        <span class="required">*</span>
                    </label>
                    {{ form.room }}
                    {% if form.room.errors %}
                        <div class="text-danger small mt-1">{{ form.room.errors }}</div>
                    {% endif %}

                    <!-- Room Preview -->
                    <div class="room-preview" id="roomPreview">
                        <div class="room-preview-icon">
                            <i class="bi bi-door-open"></i>
                        </div>
                        <div class="room-preview-details">
                            <div class="room-preview-name" id="roomPreviewName">‚Äî</div>
                            <div class="room-preview-meta" id="roomPreviewDetails">‚Äî</div>
                        </div>
                    </div>
                </div>

                <!-- Meeting Details -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="bi bi-pencil-square"></i>
                        Meeting Details
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-card-heading"></i>
                            Meeting Title
                            <span class="required">*</span>
                        </label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="text-danger small mt-1">{{ form.title.errors }}</div>
                        {% endif %}
                        <div class="help-text">
                            <i class="bi bi-info-circle"></i>
                            Provide a clear, descriptive title for your meeting
                        </div>
                    </div>

                    <div>
                        <label class="form-label">
                            <i class="bi bi-text-paragraph"></i>
                            Description
                            <span class="text-muted small">(Optional)</span>
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger small mt-1">{{ form.description.errors }}</div>
                        {% endif %}
                        <div class="help-text">
                            <i class="bi bi-info-circle"></i>
                            Add any additional details about the meeting
                        </div>
                    </div>
                </div>

                <!-- Recurring Booking Toggle -->
                <div class="recurring-toggle" id="recurringToggle">
                    <div class="recurring-toggle-content">
                        <div class="recurring-toggle-icon">
                            <i class="bi bi-arrow-repeat"></i>
                        </div>
                        <div class="recurring-toggle-text">
                            <div class="recurring-toggle-title">Recurring Meeting</div>
                            <p class="recurring-toggle-desc">Schedule this meeting to repeat on a regular basis</p>
                        </div>
                        <label class="recurring-switch">
                            <input type="checkbox" id="recurringCheckbox">
                            <span class="recurring-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Recurring Options (Hidden by default) -->
                <div class="recurring-options" id="recurringOptions">
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="bi bi-arrow-clockwise"></i>
                            Recurrence Pattern
                        </div>

                        <!-- Frequency Selection -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-calendar-range"></i>
                                Repeat Every
                            </label>
                            <div class="frequency-grid">
                                <div class="frequency-option">
                                    <input type="radio" name="frequency" value="daily" id="freq-daily">
                                    <label for="freq-daily">
                                        <i class="bi bi-sun"></i>
                                        <span>Daily</span>
                                    </label>
                                </div>
                                <div class="frequency-option">
                                    <input type="radio" name="frequency" value="weekly" id="freq-weekly">
                                    <label for="freq-weekly">
                                        <i class="bi bi-calendar-week"></i>
                                        <span>Weekly</span>
                                    </label>
                                </div>
                                <div class="frequency-option">
                                    <input type="radio" name="frequency" value="monthly" id="freq-monthly">
                                    <label for="freq-monthly">
                                        <i class="bi bi-calendar-month"></i>
                                        <span>Monthly</span>
                                    </label>
                                </div>
                                <div class="frequency-option">
                                    <input type="radio" name="frequency" value="yearly" id="freq-yearly">
                                    <label for="freq-yearly">
                                        <i class="bi bi-calendar-event"></i>
                                        <span>Yearly</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Interval -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-arrow-repeat"></i>
                                Repeat Every
                            </label>
                            <div class="row g-3 align-items-center">
                                <div class="col-auto">
                                    {{ form.interval }}
                                </div>
                                <div class="col-auto">
                                    <span id="intervalLabel">week(s)</span>
                                </div>
                            </div>
                            {% if form.interval.errors %}
                                <div class="text-danger small mt-1">{{ form.interval.errors }}</div>
                            {% endif %}
                            <div class="help-text">
                                <i class="bi bi-info-circle"></i>
                                For example: "2" for every 2 weeks, "3" for every 3 months
                            </div>
                        </div>

                        <!-- Weekdays (only for weekly) -->
                        <div class="weekdays-selector" id="weekdaysSelector">
                            <label class="form-label">
                                <i class="bi bi-calendar-check"></i>
                                Select Days of the Week
                            </label>
                            <div class="weekdays-grid">
                                <div class="weekday-option">
                                    <input type="checkbox" name="weekdays" value="0" id="day-mon">
                                    <label for="day-mon">Mon</label>
                                </div>
                                <div class="weekday-option">
                                    <input type="checkbox" name="weekdays" value="1" id="day-tue">
                                    <label for="day-tue">Tue</label>
                                </div>
                                <div class="weekday-option">
                                    <input type="checkbox" name="weekdays" value="2" id="day-wed">
                                    <label for="day-wed">Wed</label>
                                </div>
                                <div class="weekday-option">
                                    <input type="checkbox" name="weekdays" value="3" id="day-thu">
                                    <label for="day-thu">Thu</label>
                                </div>
                                <div class="weekday-option">
                                    <input type="checkbox" name="weekdays" value="4" id="day-fri">
                                    <label for="day-fri">Fri</label>
                                </div>
                                <div class="weekday-option">
                                    <input type="checkbox" name="weekdays" value="5" id="day-sat">
                                    <label for="day-sat">Sat</label>
                                </div>
                                <div class="weekday-option">
                                    <input type="checkbox" name="weekdays" value="6" id="day-sun">
                                    <label for="day-sun">Sun</label>
                                </div>
                            </div>
                            {% if form.weekdays.errors %}
                                <div class="text-danger small mt-1">{{ form.weekdays.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- End Date -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-calendar-x"></i>
                                End Date (Repeat Until)
                            </label>
                            {{ form.until }}
                            {% if form.until.errors %}
                                <div class="text-danger small mt-1">{{ form.until.errors }}</div>
                            {% endif %}
                            <div class="help-text">
                                <i class="bi bi-info-circle"></i>
                                Leave blank to continue indefinitely (up to 1 year maximum)
                            </div>
                        </div>

                        <!-- Occurrence Preview -->
                        <div class="occurrence-preview" id="occurrencePreview">
                            <div class="occurrence-preview-content">
                                <div class="occurrence-preview-icon">üìÖ</div>
                                <div class="occurrence-preview-text">
                                    <div class="small text-muted mb-1">Estimated Occurrences</div>
                                    <div class="occurrence-count" id="occurrenceCount">‚Äî</div>
                                    <div class="small">meetings will be created</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date & Time -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="bi bi-clock"></i>
                        <span id="dateTimeTitle">Date & Time</span>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label">
                                <i class="bi bi-calendar3"></i>
                                <span id="dateLabel">Date</span>
                                <span class="required">*</span>
                            </label>
                            {{ form.date }}
                            {% if form.date.errors %}
                                <div class="text-danger small mt-1">{{ form.date.errors }}</div>
                            {% endif %}
                            <div class="help-text" id="dateHelp">
                                <i class="bi bi-info-circle"></i>
                                Select the date for your meeting
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-clock"></i>
                                Start Time
                                <span class="required">*</span>
                            </label>
                            {{ form.start_time }}
                            {% if form.start_time.errors %}
                                <div class="text-danger small mt-1">{{ form.start_time.errors }}</div>
                            {% endif %}

                            <!-- Quick Time Buttons -->
                            <div class="quick-times">
                                <button type="button" class="quick-time-btn" data-time="09:00">9:00 AM</button>
                                <button type="button" class="quick-time-btn" data-time="10:00">10:00 AM</button>
                                <button type="button" class="quick-time-btn" data-time="14:00">2:00 PM</button>
                                <button type="button" class="quick-time-btn" data-time="15:00">3:00 PM</button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-clock-fill"></i>
                                End Time
                                <span class="required">*</span>
                            </label>
                            {{ form.end_time }}
                            {% if form.end_time.errors %}
                                <div class="text-danger small mt-1">{{ form.end_time.errors }}</div>
                            {% endif %}

                            <!-- Quick Duration Buttons -->
                            <div class="quick-times">
                                <button type="button" class="quick-duration-btn" data-duration="30">30 min</button>
                                <button type="button" class="quick-duration-btn" data-duration="60">1 hour</button>
                                <button type="button" class="quick-duration-btn" data-duration="90">1.5 hours</button>
                                <button type="button" class="quick-duration-btn" data-duration="120">2 hours</button>
                            </div>
                        </div>
                    </div>

                    <!-- Duration Estimate -->
                    <div class="time-estimate" id="timeEstimate">
                        <div class="time-estimate-content">
                            <div class="time-estimate-icon">‚è±Ô∏è</div>
                            <div class="time-estimate-text">
                                <div class="small text-muted mb-1">Meeting Duration</div>
                                <div class="time-estimate-duration" id="durationText">‚Äî</div>
                                <div class="small" id="durationAdvice"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Form Footer -->
            <div class="form-footer d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                    <i class="bi bi-info-circle me-1"></i>
                    <span id="footerText">Your request will be sent to the room approvers</span>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'accounts:room_list' %}" class="btn btn-cancel">
                        <i class="bi bi-x-lg me-1"></i>
                        Cancel
                    </a>
                    <button type="submit" class="btn btn-submit text-white">
                        <i class="bi bi-send me-1"></i>
                        <span id="submitText">Submit Request</span>
                    </button>
                </div>
            </div>

        </form>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const roomSelect = document.querySelector('select[name="room"]');
    const dateInput = document.querySelector('input[name="date"]');
    const startTimeInput = document.querySelector('input[name="start_time"]');
    const endTimeInput = document.querySelector('input[name="end_time"]');
    const timeEstimate = document.getElementById('timeEstimate');
    const durationText = document.getElementById('durationText');
    const durationAdvice = document.getElementById('durationAdvice');
    const roomPreview = document.getElementById('roomPreview');

    // Recurring elements
    const recurringCheckbox = document.getElementById('recurringCheckbox');
    const recurringOptions = document.getElementById('recurringOptions');
    const frequencyRadios = document.querySelectorAll('input[name="frequency"]');
    const weekdaysSelector = document.getElementById('weekdaysSelector');
    const intervalLabel = document.getElementById('intervalLabel');
    const untilInput = document.querySelector('input[name="until"]');
    const occurrencePreview = document.getElementById('occurrencePreview');
    const occurrenceCount = document.getElementById('occurrenceCount');

    // Set minimum date to today
    if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.setAttribute('min', today);
    }

    if (untilInput) {
        const today = new Date().toISOString().split('T')[0];
        untilInput.setAttribute('min', today);
    }

    // Room preview
    if (roomSelect) {
        roomSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                roomPreview.classList.add('show');
                document.getElementById('roomPreviewName').textContent = selectedOption.text;
                document.getElementById('roomPreviewDetails').textContent = 'View availability and details';
            } else {
                roomPreview.classList.remove('show');
            }
        });

        if (roomSelect.value) {
            roomSelect.dispatchEvent(new Event('change'));
        }
    }

    // Disable/enable all recurring inputs so they are NOT submitted when toggle is off
    function setRecurringInputsDisabled(disabled) {
        if (!recurringOptions) return;
        recurringOptions.querySelectorAll('input, select, textarea').forEach(function(el) {
            el.disabled = disabled;
        });
    }

    // On page load: recurring is off, disable all recurring inputs immediately
    setRecurringInputsDisabled(true);

    // Recurring toggle
    const isRecurringInput = document.getElementById('isRecurringInput');

    if (recurringCheckbox) {
        recurringCheckbox.addEventListener('change', function() {
            if (this.checked) {
                isRecurringInput.value = 'on';   // truthy ‚Üí Django BooleanField = True
                recurringOptions.classList.add('show');
                setRecurringInputsDisabled(false);
                updateLabelsForRecurring(true);
                calculateOccurrences();
            } else {
                isRecurringInput.value = '';     // empty ‚Üí Django BooleanField = False
                recurringOptions.classList.remove('show');
                setRecurringInputsDisabled(true);
                updateLabelsForRecurring(false);
                occurrencePreview.classList.remove('show');
            }
        });
    }

    // Frequency change
    frequencyRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const frequency = this.value;
            updateIntervalLabel(frequency);

            // Show/hide weekdays selector
            if (frequency === 'weekly') {
                weekdaysSelector.classList.add('show');
            } else {
                weekdaysSelector.classList.remove('show');
            }

            calculateOccurrences();
        });
    });

    // Update interval label based on frequency
    function updateIntervalLabel(frequency) {
        const labels = {
            'daily': 'day(s)',
            'weekly': 'week(s)',
            'monthly': 'month(s)',
            'yearly': 'year(s)'
        };
        intervalLabel.textContent = labels[frequency] || 'week(s)';
    }

    // Update labels when recurring is enabled
    function updateLabelsForRecurring(isRecurring) {
        const dateLabel = document.getElementById('dateLabel');
        const dateHelp = document.getElementById('dateHelp');
        const dateTimeTitle = document.getElementById('dateTimeTitle');
        const submitText = document.getElementById('submitText');
        const footerText = document.getElementById('footerText');

        if (isRecurring) {
            dateLabel.innerHTML = 'Start Date';
            dateHelp.innerHTML = '<i class="bi bi-info-circle"></i> Select the first occurrence date';
            dateTimeTitle.innerHTML = '<i class="bi bi-clock"></i> First Occurrence Time';
            submitText.innerHTML = 'Create Recurring Series';
            footerText.innerHTML = 'A series of meetings will be created and sent for approval';
        } else {
            dateLabel.innerHTML = 'Date';
            dateHelp.innerHTML = '<i class="bi bi-info-circle"></i> Select the date for your meeting';
            dateTimeTitle.innerHTML = '<i class="bi bi-clock"></i> Date & Time';
            submitText.innerHTML = 'Submit Request';
            footerText.innerHTML = 'Your request will be sent to the room approvers';
        }
    }

    // Calculate occurrences
    function calculateOccurrences() {
        if (!recurringCheckbox.checked || !dateInput.value) {
            occurrencePreview.classList.remove('show');
            return;
        }

        const startDate = new Date(dateInput.value);
        let endDate = untilInput.value ? new Date(untilInput.value) : new Date(startDate.getTime() + (365 * 24 * 60 * 60 * 1000));

        const frequency = document.querySelector('input[name="frequency"]:checked')?.value || 'weekly';
        const interval = parseInt(document.querySelector('input[name="interval"]')?.value || 1);

        let count = 0;
        let current = new Date(startDate);

        // Simple estimation
        if (frequency === 'daily') {
            const days = Math.floor((endDate - startDate) / (24 * 60 * 60 * 1000));
            count = Math.floor(days / interval) + 1;
        } else if (frequency === 'weekly') {
            const selectedDays = document.querySelectorAll('input[name="weekdays"]:checked').length;
            const weeks = Math.floor((endDate - startDate) / (7 * 24 * 60 * 60 * 1000));
            count = Math.floor(weeks / interval) * (selectedDays || 1);
        } else if (frequency === 'monthly') {
            const months = (endDate.getFullYear() - startDate.getFullYear()) * 12 + (endDate.getMonth() - startDate.getMonth());
            count = Math.floor(months / interval) + 1;
        } else if (frequency === 'yearly') {
            const years = endDate.getFullYear() - startDate.getFullYear();
            count = Math.floor(years / interval) + 1;
        }

        count = Math.max(1, Math.min(count, 365)); // Cap at 365

        occurrenceCount.textContent = count;
        occurrencePreview.classList.add('show');
    }

    // Listen for changes that affect occurrence count
    if (untilInput) {
        untilInput.addEventListener('change', calculateOccurrences);
    }

    document.querySelector('input[name="interval"]')?.addEventListener('change', calculateOccurrences);

    document.querySelectorAll('input[name="weekdays"]').forEach(checkbox => {
        checkbox.addEventListener('change', calculateOccurrences);
    });

    if (dateInput) {
        dateInput.addEventListener('change', calculateOccurrences);
    }

    // Quick time buttons
    document.querySelectorAll('.quick-time-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const time = this.dataset.time;
            if (startTimeInput) {
                startTimeInput.value = time;
                calculateDuration();
            }
        });
    });

    // Quick duration buttons
    document.querySelectorAll('.quick-duration-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            if (!startTimeInput.value) {
                alert('Please select a start time first');
                return;
            }

            const duration = parseInt(this.dataset.duration);
            const start = startTimeInput.value.split(':');
            const startMinutes = parseInt(start[0]) * 60 + parseInt(start[1]);
            const endMinutes = startMinutes + duration;

            const endHours = Math.floor(endMinutes / 60) % 24;
            const endMins = endMinutes % 60;

            endTimeInput.value = `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
            calculateDuration();
        });
    });

    // Calculate duration when times change
    if (startTimeInput && endTimeInput) {
        startTimeInput.addEventListener('change', calculateDuration);
        endTimeInput.addEventListener('change', calculateDuration);
    }

    function calculateDuration() {
        if (!startTimeInput.value || !endTimeInput.value) {
            timeEstimate.classList.remove('show');
            return;
        }

        const start = startTimeInput.value.split(':');
        const end = endTimeInput.value.split(':');

        const startMinutes = parseInt(start[0]) * 60 + parseInt(start[1]);
        let endMinutes = parseInt(end[0]) * 60 + parseInt(end[1]);

        if (endMinutes < startMinutes) {
            endMinutes += 24 * 60;
        }

        const durationMinutes = endMinutes - startMinutes;

        if (durationMinutes > 0) {
            timeEstimate.classList.add('show');

            const hours = Math.floor(durationMinutes / 60);
            const minutes = durationMinutes % 60;
            let durationStr = '';

            if (hours > 0) {
                durationStr += hours + ' hour' + (hours > 1 ? 's' : '');
            }
            if (minutes > 0) {
                if (hours > 0) durationStr += ' ';
                durationStr += minutes + ' min';
            }

            durationText.textContent = durationStr;

            if (durationMinutes <= 60) {
                durationAdvice.innerHTML = '<span class="text-success"><i class="bi bi-check-circle me-1"></i>Optimal duration ‚Äì easy to share the room</span>';
            } else if (durationMinutes <= 180) {
                durationAdvice.innerHTML = '<span class="text-warning"><i class="bi bi-info-circle me-1"></i>Moderate duration ‚Äì consider if you need the full time</span>';
            } else {
                durationAdvice.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Extended session ‚Äì try to break into shorter meetings if possible</span>';
            }
        } else {
            timeEstimate.classList.remove('show');
        }
    }

    // Form submission ‚Äî safety: if recurring toggle is off, uncheck all frequency radios
    // before submit so the server never sees a frequency value for a single booking.
    const form = document.getElementById('bookingForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (recurringCheckbox && !recurringCheckbox.checked) {
                document.querySelectorAll('input[name="frequency"]').forEach(function(r) {
                    r.checked = false;
                    r.disabled = true;
                });
                document.querySelectorAll('input[name="interval"], input[name="until"], input[name="weekdays"]').forEach(function(el) {
                    el.disabled = true;
                });
            }
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
        });
    }
});
</script>
{% endblock %}