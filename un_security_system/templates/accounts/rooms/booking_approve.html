{% extends "base.html" %}
{% block title %}Approve Booking{% endblock %}

{% block extra_css %}
<style>
    .approval-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .approval-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 16px;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }

    .approval-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 400px;
        height: 400px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }

    .approval-header-content {
        position: relative;
        z-index: 1;
    }

    .approval-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 1rem;
        backdrop-filter: blur(10px);
    }

    .booking-details-card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 0.5rem 2rem rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .booking-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        padding: 1.5rem;
        border-bottom: 2px solid #e5e7eb;
    }

    .booking-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .booking-title i {
        color: #667eea;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        padding: 1.5rem;
    }

    .info-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }

    .info-icon {
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        flex-shrink: 0;
    }

    .info-content {
        flex: 1;
    }

    .info-label {
        font-size: 0.8rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .info-value {
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
    }

    .info-sub {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }

    .duration-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.9rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        margin-top: 0.5rem;
    }

    .duration-optimal {
        background: #d1f4e0;
        color: #0f6938;
    }

    .duration-moderate {
        background: #fff3cd;
        color: #856404;
    }

    .duration-extended {
        background: #ffe0e0;
        color: #b91c1c;
    }

    .description-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-top: 2px solid #e5e7eb;
    }

    .description-section h6 {
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .requester-card {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .requester-avatar {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: 700;
        flex-shrink: 0;
    }

    .requester-info {
        flex: 1;
    }

    .requester-name {
        font-weight: 700;
        font-size: 1.1rem;
        color: #1f2937;
    }

    .requester-label {
        font-size: 0.85rem;
        color: #6b7280;
    }

    .decision-card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 0.5rem 2rem rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .decision-header {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        padding: 1.5rem;
    }

    .decision-header h5 {
        margin: 0;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .action-btn {
        flex: 1;
        padding: 1rem;
        border: 3px solid #e5e7eb;
        border-radius: 12px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .action-btn input[type="radio"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    .action-btn-content {
        position: relative;
        z-index: 1;
    }

    .action-btn i {
        font-size: 2.5rem;
        display: block;
        margin-bottom: 0.5rem;
    }

    .action-btn-label {
        font-weight: 700;
        font-size: 1.1rem;
        display: block;
        margin-bottom: 0.25rem;
    }

    .action-btn-desc {
        font-size: 0.85rem;
        color: #6b7280;
    }

    .action-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
    }

    .action-btn.approve {
        border-color: #e5e7eb;
    }

    .action-btn.approve:hover {
        border-color: #10b981;
        background: #ecfdf5;
    }

    .action-btn.approve i {
        color: #10b981;
    }

    .action-btn.approve.selected {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-color: #10b981;
    }

    .action-btn.approve.selected i,
    .action-btn.approve.selected .action-btn-label,
    .action-btn.approve.selected .action-btn-desc {
        color: white;
    }

    .action-btn.reject {
        border-color: #e5e7eb;
    }

    .action-btn.reject:hover {
        border-color: #ef4444;
        background: #fef2f2;
    }

    .action-btn.reject i {
        color: #ef4444;
    }

    .action-btn.reject.selected {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border-color: #ef4444;
    }

    .action-btn.reject.selected i,
    .action-btn.reject.selected .action-btn-label,
    .action-btn.reject.selected .action-btn-desc {
        color: white;
    }

    .reason-section {
        padding: 1.5rem;
        display: none;
    }

    .reason-section.show {
        display: block;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-label .required {
        color: #ef4444;
    }

    textarea.form-control {
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.75rem;
        min-height: 120px;
        resize: vertical;
        transition: all 0.3s ease;
    }

    textarea.form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.15);
    }

    .decision-footer {
        background: #f8f9fa;
        padding: 1.5rem;
        border-top: 2px solid #e5e7eb;
    }

    .btn-submit-decision {
        padding: 0.75rem 2rem;
        font-weight: 600;
        border-radius: 10px;
        border: none;
        transition: all 0.3s ease;
    }

    .btn-submit-decision.approve-submit {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .btn-submit-decision.reject-submit {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    .btn-submit-decision:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.2);
    }

    .btn-back {
        padding: 0.75rem 2rem;
        font-weight: 600;
        border-radius: 10px;
        border: 2px solid #e5e7eb;
        background: white;
        transition: all 0.2s;
    }

    .btn-back:hover {
        border-color: #667eea;
        background: #f0f4ff;
        color: #667eea;
    }

    .quick-response-templates {
        margin-top: 0.5rem;
    }

    .template-btn {
        padding: 0.4rem 0.8rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        transition: all 0.2s;
    }

    .template-btn:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }

    @media (max-width: 768px) {
        .info-grid {
            grid-template-columns: 1fr;
        }
        .action-buttons {
            flex-direction: column;
        }
        .decision-footer {
            flex-direction: column;
            gap: 0.75rem;
        }
        .btn-submit-decision,
        .btn-back {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="approval-container">

        <!-- Header -->
        <div class="approval-header">
            <div class="approval-header-content">
                <span class="approval-badge">
                    <i class="bi bi-shield-check me-1"></i>
                    Approval Required
                </span>
                <h2 class="mb-0 fw-bold">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Review Booking Request
                </h2>
            </div>
        </div>

        <!-- Booking Details Card -->
        <div class="booking-details-card">
            <div class="booking-header">
                <div class="booking-title">
                    <i class="bi bi-calendar-event"></i>
                    {{ booking.title }}
                </div>
            </div>

            <div class="info-grid">
                <!-- Room Info -->
                <div class="info-item">
                    <div class="info-icon">
                        <i class="bi bi-door-open"></i>
                    </div>
                    <div class="info-content">
                        <div class="info-label">Room</div>
                        <div class="info-value">{{ room.name }}</div>
                        <div class="info-sub">
                            {{ room.code }} · {{ room.get_room_type_display }}
                            {% if room.location %}
                                · {{ room.location }}
                            {% endif %}
                        </div>
                        {% if room.capacity %}
                            <div class="info-sub">
                                <i class="bi bi-people me-1"></i>
                                Capacity: {{ room.capacity }}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Date & Time -->
                <div class="info-item">
                    <div class="info-icon">
                        <i class="bi bi-clock"></i>
                    </div>
                    <div class="info-content">
                        <div class="info-label">Date & Time</div>
                        <div class="info-value">{{ booking.date|date:"M d, Y (D)" }}</div>
                        <div class="info-sub">
                            {{ booking.start_time|time:"H:i" }} – {{ booking.end_time|time:"H:i" }}
                        </div>
                        {% if booking.duration_minutes %}
                            <div class="duration-badge duration-{{ booking.duration_class|default:'optimal' }}">
                                <i class="bi bi-hourglass-split"></i>
                                {{ booking.duration_minutes }} minutes
                                {% if booking.duration_minutes <= 60 %}
                                    (Optimal)
                                {% elif booking.duration_minutes <= 180 %}
                                    (Moderate)
                                {% else %}
                                    (Extended)
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Description -->
            {% if booking.description %}
                <div class="description-section">
                    <h6>
                        <i class="bi bi-card-text"></i>
                        Additional Details
                    </h6>
                    <p class="mb-0 text-muted">{{ booking.description }}</p>
                </div>
            {% endif %}

            <!-- Requester Info -->
            <div class="description-section border-top-0 pt-0">
                <h6>
                    <i class="bi bi-person"></i>
                    Requested By
                </h6>
                <div class="requester-card">
                    <div class="requester-avatar">
                        {{ booking.requested_by.get_full_name|slice:":1"|upper }}
                    </div>
                    <div class="requester-info">
                        <div class="requester-name">
                            {{ booking.requested_by.get_full_name }}
                        </div>
                        <div class="requester-label">
                            <i class="bi bi-envelope me-1"></i>
                            {{ booking.requested_by.email }}
                        </div>
                        <div class="requester-label">
                            <i class="bi bi-clock-history me-1"></i>
                            Requested {{ booking.created_at|timesince }} ago
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Decision Form -->
        <form method="post" class="decision-card" id="decisionForm">
            {% csrf_token %}

            <div class="decision-header">
                <h5>
                    <i class="bi bi-hand-thumbs-up"></i>
                    Make Your Decision
                </h5>
            </div>

            <div class="card-body p-0">
                <!-- Action Selection -->
                <div style="padding: 1.5rem;">
                    <div class="action-buttons">
                        <label class="action-btn approve" id="approveBtn">
                            <input type="radio" name="action" value="approve" required>
                            <div class="action-btn-content">
                                <i class="bi bi-check-circle"></i>
                                <span class="action-btn-label">Approve</span>
                                <span class="action-btn-desc">Grant access to this room</span>
                            </div>
                        </label>

                        <label class="action-btn reject" id="rejectBtn">
                            <input type="radio" name="action" value="reject" required>
                            <div class="action-btn-content">
                                <i class="bi bi-x-circle"></i>
                                <span class="action-btn-label">Reject</span>
                                <span class="action-btn-desc">Decline this request</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Reason Section (shown when reject is selected) -->
                <div class="reason-section" id="reasonSection">
                    <label class="form-label">
                        <i class="bi bi-chat-left-text"></i>
                        Reason for Rejection
                        <span class="required">*</span>
                    </label>
                    {{ form.reason }}
                    <div class="help-text text-muted small mt-2">
                        <i class="bi bi-info-circle me-1"></i>
                        Please provide a clear reason to help the requester understand
                    </div>

                    <!-- Quick Templates -->
                    <div class="quick-response-templates">
                        <div class="small text-muted mb-2">Quick responses:</div>
                        <button type="button" class="template-btn" data-template="Room is already booked for that time slot.">
                            Already Booked
                        </button>
                        <button type="button" class="template-btn" data-template="This room requires advance approval. Please book at least 48 hours in advance.">
                            Insufficient Notice
                        </button>
                        <button type="button" class="template-btn" data-template="A smaller room would be more appropriate for this meeting size.">
                            Wrong Room Size
                        </button>
                        <button type="button" class="template-btn" data-template="Please provide more details about the purpose of this meeting.">
                            Need More Info
                        </button>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="decision-footer d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                    <i class="bi bi-info-circle me-1"></i>
                    The requester will be notified of your decision
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'accounts:room_approvals' %}" class="btn btn-back">
                        <i class="bi bi-arrow-left me-1"></i>
                        Back
                    </a>
                    <button type="submit" class="btn btn-submit-decision approve-submit" id="submitBtn" disabled>
                        <i class="bi bi-send me-1"></i>
                        Submit Decision
                    </button>
                </div>
            </div>
        </form>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const approveBtn = document.getElementById('approveBtn');
    const rejectBtn = document.getElementById('rejectBtn');
    const reasonSection = document.getElementById('reasonSection');
    const reasonTextarea = document.querySelector('textarea[name="reason"]');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('decisionForm');
    const actionButtons = document.querySelectorAll('.action-btn');
    const templateButtons = document.querySelectorAll('.template-btn');

    // Handle action selection
    actionButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove selected class from all buttons
            actionButtons.forEach(b => b.classList.remove('selected'));
            // Add selected class to clicked button
            this.classList.add('selected');

            // Get the radio button value
            const action = this.querySelector('input[type="radio"]').value;

            // Show/hide reason section
            if (action === 'reject') {
                reasonSection.classList.add('show');
                reasonTextarea.required = true;
                submitBtn.classList.remove('approve-submit');
                submitBtn.classList.add('reject-submit');
                submitBtn.innerHTML = '<i class="bi bi-x-circle me-1"></i>Reject Booking';
            } else {
                reasonSection.classList.remove('show');
                reasonTextarea.required = false;
                reasonTextarea.value = '';
                submitBtn.classList.remove('reject-submit');
                submitBtn.classList.add('approve-submit');
                submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Approve Booking';
            }

            // Enable submit button
            submitBtn.disabled = false;
        });
    });

    // Quick response templates
    templateButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const template = this.dataset.template;
            reasonTextarea.value = template;
            reasonTextarea.focus();
        });
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        const selectedAction = document.querySelector('input[name="action"]:checked');

        if (!selectedAction) {
            e.preventDefault();
            alert('Please select an action (Approve or Reject)');
            return;
        }

        if (selectedAction.value === 'reject' && !reasonTextarea.value.trim()) {
            e.preventDefault();
            alert('Please provide a reason for rejection');
            reasonTextarea.focus();
            return;
        }

        // Disable submit button and show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
    });

    // Auto-resize textarea
    if (reasonTextarea) {
        reasonTextarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    }
});
</script>
{% endblock %}