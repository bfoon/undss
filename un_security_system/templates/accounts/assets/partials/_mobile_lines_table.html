<!-- templates/accounts/assets/partials/_mobile_lines_table.html -->
<!-- Updated: Pagination + Select All (current page) + Keeps your analytics -->
<!-- Source file: :contentReference[oaicite:0]{index=0} -->

<!-- Enhanced Mobile Lines Table with Filter, Search, and Analysis -->

<!-- Filter and Search Controls -->
<div class="card mb-3">
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <!-- Search -->
      <div class="col-md-4">
        <label class="form-label small fw-semibold">Search Mobile Lines</label>
        <input type="text"
               class="form-control"
               id="lineSearchInput"
               placeholder="Search by MSISDN, provider, user...">
      </div>

      <!-- Type Filter -->
      <div class="col-md-2">
        <label class="form-label small fw-semibold">Type</label>
        <select class="form-select" id="lineTypeFilter">
          <option value="">All Types</option>
          <!-- ✅ match your model enums if needed -->
          <option value="sim">SIM</option>
          <option value="data">Data</option>
          <option value="sim_data">SIM + Data</option>
        </select>
      </div>

      <!-- Status Filter -->
      <div class="col-md-2">
        <label class="form-label small fw-semibold">Status</label>
        <select class="form-select" id="lineStatusFilter">
          <option value="">All Status</option>
          <option value="available">Available</option>
          <option value="assigned">Assigned</option>
          <option value="suspended">Suspended</option>
          <option value="retired">Retired</option>
        </select>
      </div>

      <!-- Provider Filter -->
      <div class="col-md-2">
        <label class="form-label small fw-semibold">Provider</label>
        <select class="form-select" id="lineProviderFilter">
          <option value="">All Providers</option>
          {% for line in mobile_lines_visible %}
            {% if line.provider %}
              <option value="{{ line.provider|lower }}">{{ line.provider }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>

      <!-- Action Buttons -->
      <div class="col-md-2">
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary btn-sm" id="btnResetLineFilters" title="Reset Filters">
            <i class="bi bi-arrow-counterclockwise"></i>
          </button>
          <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalLineAnalysis" title="View Analytics">
            <i class="bi bi-graph-up"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Results Summary + NEW pagination controls -->
    <div class="mt-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
      <small class="text-muted">
        Showing <span id="lineResultCount" class="fw-semibold">{{ mobile_lines_visible|length }}</span> of {{ mobile_lines_visible|length }} mobile lines
      </small>

      <!-- NEW: Pagination Controls -->
      <div class="d-flex align-items-center gap-2">
        <label class="small text-muted mb-0">Rows</label>
        <select id="linePageSize" class="form-select form-select-sm" style="width:110px;">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>

        <nav aria-label="Mobile lines pagination">
          <ul class="pagination pagination-sm mb-0" id="linePagination"></ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Header with Actions -->
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <div>
    <h6 class="mb-0"><i class="bi bi-sim me-2"></i>Mobile Lines</h6>
    <div class="text-muted small">SIM cards and data plan lines registered by ICT custodian.</div>
  </div>

  <div class="d-flex gap-2">
    <!-- NEW: optional “Print Selected” (only if you have a pdf endpoint; remove if not needed) -->
    <!--
    <button class="btn btn-sm btn-outline-secondary" id="btnPrintSelectedLines">
      <i class="bi bi-printer me-1"></i> Print Selected
    </button>
    -->

    {% if is_ict %}
      <button class="btn btn-sm btn-outline-primary"
              data-bs-toggle="modal"
              data-bs-target="#modalRegisterMobileLine">
        <i class="bi bi-plus-circle me-1"></i> Register Mobile Line
      </button>
    {% endif %}
  </div>
</div>

<!-- Mobile Lines Table -->
<div class="table-responsive">
  <table class="table table-sm align-middle" id="mobileLinesTable">
    <thead>
      <tr>
        <!-- UPDATED: Select all checkbox -->
        <th>
          <div class="d-flex align-items-center gap-2">
            <input type="checkbox" class="form-check-input" id="selectAllLines">
            <span>MSISDN</span>
          </div>
        </th>
        <th>Type</th>
        <th>Provider</th>
        <th>Status</th>
        <th>Assigned To</th>
        <th>Custodian</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      {% for line in mobile_lines_visible %}
        <tr class="line-row"
            data-msisdn="{{ line.msisdn|lower }}"
            data-type="{{ line.line_type }}"
            data-provider="{{ line.provider|default:''|lower }}"
            data-status="{{ line.status }}"
            data-assigned="{{ line.assigned_to.get_full_name|default:''|lower }}"
            data-custodian="{{ line.custodian.get_full_name|default:''|lower }}">

          <td class="fw-semibold">
            <input type="checkbox" class="form-check-input am-line-check me-2" value="{{ line.id }}">
            {{ line.msisdn }}
          </td>

          <td>{{ line.get_line_type_display }}</td>
          <td>{{ line.provider|default:"-" }}</td>

          <td>
            {% if line.status == "available" %}
              <span class="badge bg-success-subtle text-success border border-success-subtle">Available</span>
            {% elif line.status == "assigned" %}
              <span class="badge bg-primary-subtle text-primary border border-primary-subtle">Assigned</span>
            {% elif line.status == "suspended" %}
              <span class="badge bg-warning-subtle text-warning border border-warning-subtle">Suspended</span>
            {% elif line.status == "retired" %}
              <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">Retired</span>
            {% else %}
              <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">
                {{ line.get_status_display }}
              </span>
            {% endif %}
          </td>

          <td>
            {% if line.assigned_to %}
              {{ line.assigned_to.get_full_name }}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>

          <td>
            {% if line.custodian %}
              {{ line.custodian.get_full_name }}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>

          <td class="text-muted">{{ line.created_at|date:"Y-m-d H:i" }}</td>

          <td>
            <div class="d-flex gap-2 flex-wrap">

              {# Assign: ICT OR Ops AND available #}
              {% if is_ict or is_ops and line.status == "available" %}
                <button class="btn btn-sm btn-outline-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#modalAssignLine"
                        data-line-id="{{ line.id }}"
                        data-msisdn="{{ line.msisdn }}">
                  <i class="bi bi-person-plus me-1"></i> Assign
                </button>
              {% endif %}

              {# Suspend: (ICT OR Ops) AND not suspended AND not retired #}
              {% if is_ict and line.status != "suspended" and line.status != "retired" %}
                <button class="btn btn-sm btn-outline-warning"
                        data-bs-toggle="modal"
                        data-bs-target="#modalSuspendLine"
                        data-line-id="{{ line.id }}"
                        data-msisdn="{{ line.msisdn }}">
                  <i class="bi bi-pause-circle me-1"></i> Suspend
                </button>
              {% elif is_ops and line.status != "suspended" and line.status != "retired" %}
                <button class="btn btn-sm btn-outline-warning"
                        data-bs-toggle="modal"
                        data-bs-target="#modalSuspendLine"
                        data-line-id="{{ line.id }}"
                        data-msisdn="{{ line.msisdn }}">
                  <i class="bi bi-pause-circle me-1"></i> Suspend
                </button>
              {% endif %}

              {% if line.status == "suspended" %}
              <button class="btn btn-sm btn-outline-success"
                      data-bs-toggle="modal"
                      data-bs-target="#modalRequestLineReactivation"
                      data-line-id="{{ line.id }}"
                      data-msisdn="{{ line.msisdn }}">
                <i class="bi bi-arrow-repeat me-1"></i> Request Reactivation
              </button>
            {% endif %}

              {% if not is_ict and not is_ops %}
                <span class="text-muted">-</span>
              {% endif %}
            </div>
          </td>
        </tr>
      {% empty %}
        <tr class="no-results">
          <td colspan="8" class="text-center text-muted py-4">No mobile lines registered yet.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- No Results Message (Hidden by default) -->
  <div id="noLineResults" class="text-center text-muted py-4" style="display: none;">
    <i class="bi bi-search fs-3 mb-2"></i>
    <p>No mobile lines match your current filters.</p>
  </div>
</div>

<!-- Mobile Lines Analysis Modal (unchanged) -->
<div class="modal fade" id="modalLineAnalysis" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-graph-up me-2"></i>Mobile Lines Analytics Dashboard
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Summary Cards -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card bg-primary text-white">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="card-subtitle mb-2 opacity-75">Total Lines</h6>
                    <h3 class="mb-0" id="totalLines">{{ mobile_lines_visible|length }}</h3>
                  </div>
                  <i class="bi bi-sim fs-1 opacity-50"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-success text-white">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="card-subtitle mb-2 opacity-75">Available</h6>
                    <h3 class="mb-0" id="availableLines">0</h3>
                  </div>
                  <i class="bi bi-check-circle fs-1 opacity-50"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-info text-white">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="card-subtitle mb-2 opacity-75">Assigned</h6>
                    <h3 class="mb-0" id="assignedLines">0</h3>
                  </div>
                  <i class="bi bi-person-check fs-1 opacity-50"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-warning text-dark">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="card-subtitle mb-2">Suspended</h6>
                    <h3 class="mb-0" id="suspendedLines">0</h3>
                  </div>
                  <i class="bi bi-pause-circle fs-1 opacity-50"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">Lines by Type</h6>
              </div>
              <div class="card-body">
                <canvas id="chartLineType" height="250"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">Lines by Status</h6>
              </div>
              <div class="card-body">
                <canvas id="chartLineStatus" height="250"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-12">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">Lines by Provider</h6>
              </div>
              <div class="card-body">
                <canvas id="chartLineProvider" height="150"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Provider Breakdown Table -->
        <div class="card mt-3">
          <div class="card-header">
            <h6 class="mb-0">Detailed Provider Breakdown</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm" id="providerBreakdownTable">
                <thead>
                  <tr>
                    <th>Provider</th>
                    <th class="text-center">Total</th>
                    <th class="text-center">Available</th>
                    <th class="text-center">Assigned</th>
                    <th class="text-center">Suspended</th>
                  </tr>
                </thead>
                <tbody id="providerBreakdownBody">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalSuspendLine" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" class="modal-content">
      {% csrf_token %}
      <input type="hidden" name="action" value="suspend_mobile_line">
      <input type="hidden" name="line_id" id="suspendLineId">

      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-pause-circle me-2"></i> Suspend Mobile Line
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="alert alert-warning">
          You are about to suspend: <strong id="suspendLineMsisdn">—</strong><br>
          This will notify the Provider Focal Point, Operations Manager, and Registry.
        </div>

        <label class="form-label fw-semibold">Reason (optional)</label>
        <textarea class="form-control" name="reason" rows="3"
                  placeholder="Example: Staff separated / SIM lost / Security incident / Request from management"></textarea>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-warning">
          <i class="bi bi-pause-circle me-1"></i> Suspend Line
        </button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="modalRequestLineReactivation" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" class="modal-content">
      {% csrf_token %}
      <input type="hidden" name="action" value="request_reactivate_line">
      <input type="hidden" name="line_id" id="reactivateLineId">

      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-arrow-repeat me-2"></i>Request Line Reactivation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="alert alert-info">
          You are requesting to reactivate: <strong id="reactivateLineMsisdn">—</strong><br>
          This requires Operations Manager approval.
        </div>

        <label class="form-label fw-semibold">Reason (optional)</label>
        <textarea class="form-control" name="reason" rows="3"
                  placeholder="Why should this line be reactivated?"></textarea>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">
          <i class="bi bi-send me-1"></i> Submit Request
        </button>
      </div>
    </form>
  </div>
</div>

<script>
document.getElementById('modalRequestLineReactivation')?.addEventListener('show.bs.modal', function (event) {
  const btn = event.relatedTarget;
  if (!btn) return;
  document.getElementById('reactivateLineId').value = btn.getAttribute('data-line-id') || '';
  document.getElementById('reactivateLineMsisdn').textContent = btn.getAttribute('data-msisdn') || '—';
});
</script>


<script>
document.getElementById('modalSuspendLine')?.addEventListener('show.bs.modal', function (event) {
  const btn = event.relatedTarget;
  if (!btn) return;

  document.getElementById('suspendLineId').value = btn.getAttribute('data-line-id') || '';
  document.getElementById('suspendLineMsisdn').textContent = btn.getAttribute('data-msisdn') || '—';
});
</script>

<script>
(function() {
  // Mobile Lines Filtering + Pagination + Select All (current page)

  const searchInput = document.getElementById('lineSearchInput');
  const typeFilter = document.getElementById('lineTypeFilter');
  const statusFilter = document.getElementById('lineStatusFilter');
  const providerFilter = document.getElementById('lineProviderFilter');
  const resetBtn = document.getElementById('btnResetLineFilters');
  const resultCount = document.getElementById('lineResultCount');
  const noResults = document.getElementById('noLineResults');
  const tableBody = document.querySelector('#mobileLinesTable tbody');

  // NEW
  const paginationEl = document.getElementById("linePagination");
  const pageSizeEl = document.getElementById("linePageSize");
  const selectAllEl = document.getElementById("selectAllLines");

  let currentPage = 1;
  let pageSize = parseInt(pageSizeEl?.value || "25", 10);

  function getAllRows() {
    return Array.from(document.querySelectorAll('.line-row'));
  }

  function getFilteredRows() {
    const searchTerm = (searchInput?.value || '').toLowerCase();
    const type = typeFilter?.value || '';
    const status = statusFilter?.value || '';
    const provider = providerFilter?.value || '';

    return getAllRows().filter(row => {
      const msisdn = (row.dataset.msisdn || '').toLowerCase();
      const rowProvider = (row.dataset.provider || '').toLowerCase();
      const assigned = (row.dataset.assigned || '').toLowerCase();
      const custodian = (row.dataset.custodian || '').toLowerCase();
      const rowType = row.dataset.type || '';
      const rowStatus = row.dataset.status || '';

      const matchesSearch = !searchTerm ||
        msisdn.includes(searchTerm) ||
        rowProvider.includes(searchTerm) ||
        assigned.includes(searchTerm) ||
        custodian.includes(searchTerm);

      const matchesType = !type || rowType === type;
      const matchesStatus = !status || rowStatus === status;
      const matchesProvider = !provider || rowProvider === provider;

      return matchesSearch && matchesType && matchesStatus && matchesProvider;
    });
  }

  function getVisiblePageRows(filteredRows) {
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    return filteredRows.slice(start, end);
  }

  function renderPagination(totalItems) {
    if (!paginationEl) return;

    const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
    if (currentPage > totalPages) currentPage = totalPages;

    paginationEl.innerHTML = "";

    const makeBtn = (label, page, disabled = false, active = false) => {
      const li = document.createElement("li");
      li.className = "page-item" + (disabled ? " disabled" : "") + (active ? " active" : "");
      const a = document.createElement("a");
      a.className = "page-link";
      a.href = "javascript:void(0)";
      a.textContent = label;
      a.addEventListener("click", () => {
        if (disabled) return;
        currentPage = page;
        applyFilters();
      });
      li.appendChild(a);
      return li;
    };

    // Prev
    paginationEl.appendChild(makeBtn("«", Math.max(1, currentPage - 1), currentPage === 1));

    // Pages (compact)
    const windowSize = 5;
    let start = Math.max(1, currentPage - 2);
    let end = Math.min(totalPages, start + windowSize - 1);
    start = Math.max(1, end - windowSize + 1);

    if (start > 1) paginationEl.appendChild(makeBtn("1", 1, false, currentPage === 1));
    if (start > 2) {
      const li = document.createElement("li");
      li.className = "page-item disabled";
      li.innerHTML = `<span class="page-link">…</span>`;
      paginationEl.appendChild(li);
    }

    for (let p = start; p <= end; p++) {
      paginationEl.appendChild(makeBtn(String(p), p, false, p === currentPage));
    }

    if (end < totalPages - 1) {
      const li = document.createElement("li");
      li.className = "page-item disabled";
      li.innerHTML = `<span class="page-link">…</span>`;
      paginationEl.appendChild(li);
    }
    if (end < totalPages) paginationEl.appendChild(makeBtn(String(totalPages), totalPages, false, currentPage === totalPages));

    // Next
    paginationEl.appendChild(makeBtn("»", Math.min(totalPages, currentPage + 1), currentPage === totalPages));
  }

  function updateSelectAllState(pageRows) {
    if (!selectAllEl) return;
    const checks = pageRows.map(r => r.querySelector(".am-line-check")).filter(Boolean);
    const checkedCount = checks.filter(cb => cb.checked).length;

    if (checks.length === 0) {
      selectAllEl.checked = false;
      selectAllEl.indeterminate = false;
      return;
    }

    if (checkedCount === 0) {
      selectAllEl.checked = false;
      selectAllEl.indeterminate = false;
    } else if (checkedCount === checks.length) {
      selectAllEl.checked = true;
      selectAllEl.indeterminate = false;
    } else {
      selectAllEl.checked = false;
      selectAllEl.indeterminate = true;
    }
  }

  function applyFilters() {
    const filteredRows = getFilteredRows();

    if (resultCount) resultCount.textContent = filteredRows.length;

    // No results
    if (filteredRows.length === 0) {
      getAllRows().forEach(r => (r.style.display = "none"));
      tableBody.style.display = 'none';
      noResults.style.display = 'block';
      renderPagination(0);
      updateSelectAllState([]);
      return;
    }

    tableBody.style.display = '';
    noResults.style.display = 'none';

    // Hide all
    getAllRows().forEach(r => (r.style.display = "none"));

    // Show page rows
    const pageRows = getVisiblePageRows(filteredRows);
    pageRows.forEach(r => (r.style.display = ""));

    renderPagination(filteredRows.length);
    updateSelectAllState(pageRows);
  }

  function resetFilters() {
    if (searchInput) searchInput.value = '';
    if (typeFilter) typeFilter.value = '';
    if (statusFilter) statusFilter.value = '';
    if (providerFilter) providerFilter.value = '';
    currentPage = 1;
    applyFilters();
  }

  // Event listeners (filters)
  searchInput?.addEventListener('input', () => { currentPage = 1; applyFilters(); });
  typeFilter?.addEventListener('change', () => { currentPage = 1; applyFilters(); });
  statusFilter?.addEventListener('change', () => { currentPage = 1; applyFilters(); });
  providerFilter?.addEventListener('change', () => { currentPage = 1; applyFilters(); });
  resetBtn?.addEventListener('click', resetFilters);

  // Page size
  pageSizeEl?.addEventListener("change", () => {
    pageSize = parseInt(pageSizeEl.value, 10) || 25;
    currentPage = 1;
    applyFilters();
  });

  // Select all (current page)
  selectAllEl?.addEventListener("change", () => {
    const filtered = getFilteredRows();
    const pageRows = getVisiblePageRows(filtered);
    pageRows.forEach(r => {
      const cb = r.querySelector(".am-line-check");
      if (cb) cb.checked = selectAllEl.checked;
    });
    updateSelectAllState(pageRows);
  });

  // Update select-all state when individual checkbox changes
  document.addEventListener("change", (e) => {
    if (!e.target.classList?.contains("am-line-check")) return;
    const filtered = getFilteredRows();
    const pageRows = getVisiblePageRows(filtered);
    updateSelectAllState(pageRows);
  });

  // Analytics charts (UNCHANGED from your file)
  const modalElement = document.getElementById('modalLineAnalysis');
  if (modalElement) {
    modalElement.addEventListener('shown.bs.modal', function() {
      initializeLineCharts();
    });
  }

  function initializeLineCharts() {
    const lines = [
      {% for line in mobile_lines_visible %}
      {
        type: "{{ line.line_type }}",
        typeDisplay: "{{ line.get_line_type_display|escapejs }}",
        provider: "{{ line.provider|default:'Unknown'|escapejs }}",
        status: "{{ line.status }}"
      },
      {% endfor %}
    ];

    const typeData = {};
    const providerData = {};
    const statusData = { available: 0, assigned: 0, suspended: 0, retired: 0 };
    const providerBreakdown = {};

    lines.forEach(line => {
      typeData[line.typeDisplay] = (typeData[line.typeDisplay] || 0) + 1;
      providerData[line.provider] = (providerData[line.provider] || 0) + 1;
      if (Object.prototype.hasOwnProperty.call(statusData, line.status)) statusData[line.status]++;

      if (!providerBreakdown[line.provider]) {
        providerBreakdown[line.provider] = { total: 0, available: 0, assigned: 0, suspended: 0, retired: 0 };
      }
      providerBreakdown[line.provider].total++;
      if (Object.prototype.hasOwnProperty.call(providerBreakdown[line.provider], line.status)) {
        providerBreakdown[line.provider][line.status]++;
      }
    });

    document.getElementById('availableLines').textContent = statusData.available;
    document.getElementById('assignedLines').textContent = statusData.assigned;
    document.getElementById('suspendedLines').textContent = statusData.suspended;

    const tbody = document.getElementById('providerBreakdownBody');
    if (tbody) {
      tbody.innerHTML = '';
      Object.keys(providerBreakdown).sort().forEach(provider => {
        const data = providerBreakdown[provider];
        const row = `
          <tr>
            <td class="fw-semibold">${provider}</td>
            <td class="text-center">${data.total}</td>
            <td class="text-center"><span class="badge bg-success">${data.available}</span></td>
            <td class="text-center"><span class="badge bg-primary">${data.assigned}</span></td>
            <td class="text-center"><span class="badge bg-warning text-dark">${data.suspended}</span></td>
          </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    }

    const colors = {
      primary: ['#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545', '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'],
      status: { available: '#198754', assigned: '#0d6efd', suspended: '#ffc107', retired: '#6c757d' }
    };

    const ctxType = document.getElementById('chartLineType');
    if (ctxType) {
      new Chart(ctxType, {
        type: 'doughnut',
        data: {
          labels: Object.keys(typeData),
          datasets: [{
            data: Object.values(typeData),
            backgroundColor: colors.primary.slice(0, Object.keys(typeData).length),
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    const ctxStatus = document.getElementById('chartLineStatus');
    if (ctxStatus) {
      new Chart(ctxStatus, {
        type: 'pie',
        data: {
          labels: ['Available', 'Assigned', 'Suspended', 'Retired'],
          datasets: [{
            data: [statusData.available, statusData.assigned, statusData.suspended, statusData.retired],
            backgroundColor: [colors.status.available, colors.status.assigned, colors.status.suspended, colors.status.retired],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
      });
    }

    const ctxProvider = document.getElementById('chartLineProvider');
    if (ctxProvider) {
      new Chart(ctxProvider, {
        type: 'bar',
        data: {
          labels: Object.keys(providerData),
          datasets: [{
            label: 'Number of Lines',
            data: Object.values(providerData),
            backgroundColor: '#0d6efd',
            borderColor: '#0d6efd',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
          plugins: { legend: { display: false } }
        }
      });
    }
  }

  // INIT
  document.addEventListener("DOMContentLoaded", () => {
    applyFilters();
  });

})();
</script>
