{% extends "base.html" %}
{% block title %}Registration Links{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12">
      <!-- Header Section -->
      <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
          <h1 class="h3 mb-2">
            <i class="bi bi-link-45deg me-2 text-primary"></i>Registration Links Management
          </h1>
          <p class="text-muted mb-0">
            <i class="bi bi-person-circle me-1"></i>
            Managed by: <strong>{{ request.user.get_full_name|default:request.user.username }}</strong>
            <span class="mx-2">â€¢</span>
            <span class="small">View and manage all registration links</span>
          </p>
        </div>
        <div class="d-flex gap-2">
          <a href="{% url 'accounts:ict_user_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-people me-1"></i>Agency Users
          </a>
          <a class="btn btn-primary" href="{% url 'accounts:create_registration_link' %}">
            <i class="bi bi-plus-circle me-1"></i>Generate New Link
          </a>
        </div>
      </div>

      <!-- Main Card -->
      <div class="card shadow-sm border-0">
        {% if invites %}
          <div class="card-header bg-light border-bottom py-3">
            <div class="d-flex justify-content-between align-items-center">
              <h2 class="h6 mb-0">
                <i class="bi bi-list-ul me-2"></i>Generated Links
              </h2>
              <span class="badge bg-primary rounded-pill">{{ invites|length }} Total</span>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width:18%">Created</th>
                  <th style="width:24%">Registration Link</th>
                  <th style="width:12%">Usage</th>
                  <th style="width:16%">Validity Period</th>
                  <th style="width:10%">Status</th>
                  <th style="width:20%" class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for invite in invites %}
                  {% with expired=invite.is_expired remaining=invite.remaining_uses %}
                  <tr class="invite-row">
                    <!-- Created At -->
                    <td>
                      <div class="d-flex flex-column">
                        <span class="fw-semibold text-dark">
                          {{ invite.created_at|date:"M j, Y" }}
                        </span>
                        <small class="text-muted">
                          {{ invite.created_at|date:"g:i A" }}
                        </small>
                        <small class="text-muted">
                          {{ invite.created_at|timesince }} ago
                        </small>
                      </div>
                    </td>

                    <!-- Registration Link -->
                    <td>
                      {% url 'accounts:register_with_invite' invite.code as rel_url %}
                      {% with full_url=request.scheme|add:"://"|add:request.get_host|add:rel_url %}
                        <div class="input-group input-group-sm">
                          <input type="text"
                                 class="form-control font-monospace small"
                                 value="{{ full_url }}"
                                 readonly
                                 id="invite-url-{{ invite.id }}"
                                 style="font-size: 0.75rem;">
                          <button class="btn btn-outline-primary"
                                  type="button"
                                  onclick="copyLink({{ invite.id }})"
                                  id="copy-btn-{{ invite.id }}"
                                  title="Copy to clipboard">
                            <i class="bi bi-clipboard"></i>
                          </button>
                        </div>
                      {% endwith %}
                      <small class="text-muted d-block mt-1">
                        Code: <code class="small bg-light px-1 rounded">{{ invite.code }}</code>
                      </small>
                    </td>

                    <!-- Usage -->
                    <td>
                      <div class="d-flex flex-column">
                        <div class="mb-1">
                          <span class="fw-bold text-dark">{{ invite.used_count }}</span>
                          <span class="text-muted">/ {{ invite.max_uses }}</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                          {% widthratio invite.used_count invite.max_uses 100 as usage_percent %}
                          <div class="progress-bar {% if usage_percent >= 100 %}bg-danger{% elif usage_percent >= 80 %}bg-warning{% else %}bg-success{% endif %}"
                               role="progressbar"
                               style="width: {{ usage_percent }}%"
                               aria-valuenow="{{ usage_percent }}"
                               aria-valuemin="0"
                               aria-valuemax="100">
                          </div>
                        </div>
                        <small class="text-muted mt-1">
                          {{ remaining }} remaining
                        </small>
                      </div>
                    </td>

                    <!-- Validity -->
                    <td>
                      <div class="d-flex flex-column">
                        <span class="text-dark">
                          <i class="bi bi-hourglass-split me-1 text-info"></i>
                          {{ invite.valid_for_hours }}h duration
                        </span>
                        <small class="text-muted mt-1">
                          <i class="bi bi-calendar-x me-1"></i>
                          Expires:
                        </small>
                        <small class="text-muted">
                          {{ invite.expires_at|date:"M j, g:i A" }}
                        </small>
                      </div>
                    </td>

                    <!-- Status -->
                    <td>
                      {% if not invite.is_active %}
                        <span class="badge bg-secondary">
                          <i class="bi bi-slash-circle me-1"></i>Manually Deactivated
                        </span>
                      {% elif invite.is_expired %}
                        <span class="badge bg-secondary">
                          <i class="bi bi-x-circle me-1"></i>Expired
                        </span>
                      {% elif remaining <= 0 %}
                        <span class="badge bg-warning text-dark">
                          <i class="bi bi-dash-circle me-1"></i>Full
                        </span>
                      {% else %}
                        <span class="badge bg-success">
                          <i class="bi bi-check-circle me-1"></i>Active
                        </span>
                      {% endif %}
                    </td>

                    <!-- Actions -->
                    <td>
                      <div class="d-flex flex-column align-items-center gap-1">
                        <div class="d-flex gap-2 justify-content-center">
                          <a href="{% url 'accounts:registration_link_detail' invite.id %}"
                             class="btn btn-sm btn-outline-primary"
                             title="View Details">
                            <i class="bi bi-eye me-1"></i>View
                          </a>

                          <!-- Toggle Active / Deactivated -->
                          <form method="post"
                                action="{% url 'accounts:registration_link_toggle_active' invite.id %}">
                            {% csrf_token %}
                            {% if invite.is_active %}
                              <button type="submit"
                                      class="btn btn-sm btn-outline-danger"
                                      title="Deactivate this link">
                                <i class="bi bi-slash-circle me-1"></i>Deactivate
                              </button>
                            {% else %}
                              <button type="submit"
                                      class="btn btn-sm btn-outline-success"
                                      title="Activate this link">
                                <i class="bi bi-arrow-counterclockwise me-1"></i>Activate
                              </button>
                            {% endif %}
                          </form>
                        </div>

                        {% if invite.is_active and not expired and remaining > 0 %}
                          <span class="badge bg-success-subtle text-success">
                            <i class="bi bi-unlock-fill me-1"></i>Usable
                          </span>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endwith %}
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Footer with Summary -->
          <div class="card-footer bg-light border-top py-3">
            <div class="row text-center">
              <div class="col-md-4">
                <div class="d-flex flex-column">
                  <span class="text-muted small">Total Links</span>
                  <span class="fw-bold text-dark fs-5">{{ total_links }}</span>
                </div>
              </div>
              <div class="col-md-4 border-start">
                <div class="d-flex flex-column">
                  <span class="text-muted small">Active Links</span>
                  <span class="fw-bold text-success fs-5">{{ active_links }}</span>
                </div>
              </div>
              <div class="col-md-4 border-start">
                <div class="d-flex flex-column">
                  <span class="text-muted small">Total Registrations</span>
                  <span class="fw-bold text-primary fs-5">{{ total_registrations }}</span>
                </div>
              </div>
            </div>
          </div>

        {% else %}
          <!-- Empty State -->
          <div class="card-body text-center py-5">
            <div class="empty-state-icon mb-4">
              <i class="bi bi-link-45deg text-muted" style="font-size: 5rem; opacity: 0.3;"></i>
            </div>
            <h3 class="h4 mb-3">No Registration Links Created</h3>
            <p class="text-muted mb-4 mx-auto" style="max-width: 500px;">
              You haven't generated any registration links yet. Create your first link to enable
              authorized personnel to register for system access.
            </p>
            <a class="btn btn-primary btn-lg" href="{% url 'accounts:create_registration_link' %}">
              <i class="bi bi-plus-circle me-2"></i>Generate First Link
            </a>

            <div class="mt-4 pt-4 border-top mx-auto" style="max-width: 600px;">
              <div class="row g-3 text-start">
                <div class="col-md-6">
                  <div class="d-flex">
                    <i class="bi bi-shield-check text-primary me-2 fs-5"></i>
                    <div>
                      <h4 class="h6 mb-1">Secure Access</h4>
                      <p class="small text-muted mb-0">Time-limited links with usage controls</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="d-flex">
                    <i class="bi bi-graph-up text-primary me-2 fs-5"></i>
                    <div>
                      <h4 class="h6 mb-1">Track Usage</h4>
                      <p class="small text-muted mb-0">Monitor registrations and link activity</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
function copyLink(inviteId) {
  const input = document.getElementById(`invite-url-${inviteId}`);
  const button = document.getElementById(`copy-btn-${inviteId}`);
  const originalHTML = button.innerHTML;

  navigator.clipboard.writeText(input.value).then(() => {
    // Success feedback
    button.innerHTML = '<i class="bi bi-check-lg"></i>';
    button.classList.remove('btn-outline-primary');
    button.classList.add('btn-success');

    // Reset after 2 seconds
    setTimeout(() => {
      button.innerHTML = originalHTML;
      button.classList.remove('btn-success');
      button.classList.add('btn-outline-primary');
    }, 2000);
  }).catch(err => {
    // Error feedback
    button.innerHTML = '<i class="bi bi-x-lg"></i>';
    button.classList.remove('btn-outline-primary');
    button.classList.add('btn-danger');

    setTimeout(() => {
      button.innerHTML = originalHTML;
      button.classList.remove('btn-danger');
      button.classList.add('btn-outline-primary');
    }, 2000);
    console.error('Copy failed:', err);
  });
}
</script>

<style>
  .invite-row {
    transition: background-color 0.2s ease;
  }

  .invite-row:hover {
    background-color: rgba(13, 110, 253, 0.05);
  }

  .card {
    border-radius: 0.5rem;
  }

  .progress {
    border-radius: 3px;
  }

  .font-monospace {
    background-color: #f8f9fa;
  }

  code {
    font-size: 0.8em;
  }

  .empty-state-icon {
    animation: fadeIn 0.5s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .btn-sm {
    font-size: 0.813rem;
    padding: 0.375rem 0.75rem;
  }

  .badge {
    font-weight: 500;
  }
</style>
{% endblock %}
