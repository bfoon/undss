{% extends "base.html" %}
{% load static %}

{% block title %}Log Package at Gate{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --primary-color: #667eea;
    --border-color: #e2e8f0;
    --text-dark: #2d3748;
    --text-muted: #718096;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .bg-gradient {
    background: var(--primary-gradient);
  }

  .card {
    border-radius: 0.75rem;
    overflow: hidden;
    border: 1px solid var(--border-color);
  }

  .card-header {
    border-bottom: none;
  }

  .form-label {
    color: var(--text-dark);
    font-size: 0.95rem;
    margin-bottom: 0.5rem;
  }

  .form-label .text-danger {
    font-size: 1.1em;
  }

  .form-control,
  .form-select {
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 0.625rem 0.875rem;
    font-size: 0.95rem;
    transition: all 0.2s ease;
  }

  .form-control:focus,
  .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
  }

  .form-control.is-invalid,
  .form-select.is-invalid {
    border-color: #dc3545;
  }

  .btn {
    font-weight: 500;
    border-radius: 0.5rem;
    padding: 0.625rem 1.25rem;
    transition: all 0.2s ease;
  }

  .btn-primary {
    background: var(--primary-gradient);
    border: none;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .btn-outline-primary:hover {
    background: var(--primary-gradient);
    border-color: transparent;
    color: white;
  }

  .btn-outline-secondary:hover {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
  }

  .alert {
    border-radius: 0.5rem;
    border: none;
  }

  .alert-danger {
    background-color: #fff5f5;
    color: #c53030;
    border-left: 4px solid #dc3545;
  }

  .alert-success {
    background-color: #f0fdf4;
    color: #166534;
    border-left: 4px solid #10b981;
  }

  /* Select2 styling */
  .select2-container--default .select2-selection--single {
    height: calc(2.5rem + 2px) !important;
    border-radius: 0.5rem !important;
    border: 1px solid var(--border-color) !important;
    display: flex;
    align-items: center;
  }

  .select2-container--default.select2-container--focus .select2-selection--single {
    border-color: var(--primary-color) !important;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
  }

  .select2-container--default .select2-selection--single .select2-selection__rendered {
    padding-left: 0.875rem;
    line-height: 2.5rem;
    color: var(--text-dark);
  }

  .select2-container--default .select2-selection--single .select2-selection__placeholder {
    color: var(--text-muted);
  }

  .select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 100%;
    right: 0.875rem;
  }

  .select2-dropdown {
    border-radius: 0.5rem;
    border-color: var(--border-color);
  }

  .select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: var(--primary-color);
  }

  /* Field help text */
  .form-text {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
  }

  /* Loading state */
  .loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  }

  .loading-overlay.active {
    display: flex;
  }

  .spinner-border {
    width: 3rem;
    height: 3rem;
  }

  /* Responsive improvements */
  @media (max-width: 768px) {
    .container {
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .card-body {
      padding: 1.5rem !important;
    }

    .d-flex.gap-2 {
      flex-direction: column;
    }

    .d-flex.gap-2 .btn {
      width: 100%;
    }
  }

  /* Required field indicator */
  .required-fields-note {
    font-size: 0.875rem;
    color: var(--text-muted);
    padding: 0.75rem;
    background-color: #f7fafc;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4" style="max-width: 900px;">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <div>
      <h2 class="fw-bold mb-1">
        <i class="bi bi-box-seam me-2 text-primary"></i>Log Package at Gate
      </h2>
      <p class="text-muted mb-0">Record incoming package details for reception processing</p>
    </div>
    <a href="{% url 'vehicles:package_list' %}" class="btn btn-outline-primary">
      <i class="bi bi-list-ul me-2"></i>View All Packages
    </a>
  </div>

  <!-- Form Card -->
  <div class="card shadow-sm">
    <div class="card-header bg-gradient text-white py-3">
      <h5 class="mb-0">
        <i class="bi bi-pencil-square me-2"></i>Package Information
      </h5>
    </div>

    <div class="card-body p-4">

      <!-- Display form errors -->
      {% if form.errors %}
      <div class="alert alert-danger" role="alert">
        <strong><i class="bi bi-exclamation-triangle me-2"></i>Unable to save package</strong>
        <ul class="mt-2 mb-0">
          {% for field in form %}
            {% for error in field.errors %}
              <li><strong>{{ field.label }}:</strong> {{ error }}</li>
            {% endfor %}
          {% endfor %}
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <!-- Required fields note -->
      <div class="required-fields-note">
        <i class="bi bi-info-circle me-1"></i>
        Fields marked with <span class="text-danger">*</span> are required
      </div>

      <form method="post" id="packageForm" novalidate>
        {% csrf_token %}

        <div class="row g-4">

          <!-- Sender Information Section -->
          <div class="col-12">
            <h6 class="text-muted text-uppercase mb-3" style="font-size: 0.875rem; letter-spacing: 0.5px;">
              <i class="bi bi-person me-1"></i>Sender Information
            </h6>
          </div>

          <!-- Sender Name -->
          <div class="col-md-6">
            <label for="id_sender_name" class="form-label fw-semibold">Sender Name</label>
            <input type="text"
                   id="id_sender_name"
                   name="sender_name"
                   class="form-control"
                   placeholder="Enter sender's full name"
                   value="{{ form.sender_name.value|default:'' }}">
            {% if form.sender_name.help_text %}
            <div class="form-text">{{ form.sender_name.help_text }}</div>
            {% endif %}
            {% if form.sender_name.errors %}
            <div class="invalid-feedback d-block">{{ form.sender_name.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Sender Type -->
          <div class="col-md-6">
            <label for="id_sender_type" class="form-label fw-semibold">Sender Type</label>
            <select id="id_sender_type"
                    name="sender_type"
                    class="form-select select2-basic">
              <option value="">Select sender type</option>
              <option value="Government" {% if form.sender_type.value == "Government" %}selected{% endif %}>Government / Law Enforcement</option>
              <option value="Private" {% if form.sender_type.value == "Private" %}selected{% endif %}>Private Sector</option>
              <option value="NGO" {% if form.sender_type.value == "NGO" %}selected{% endif %}>NGO</option>
              <option value="Non-Profit" {% if form.sender_type.value == "Non-Profit" %}selected{% endif %}>Non-Profit</option>
              <option value="Individual" {% if form.sender_type.value == "Individual" %}selected{% endif %}>Individual</option>
              <option value="Other" {% if form.sender_type.value == "Other" %}selected{% endif %}>Other</option>
            </select>
            {% if form.sender_type.errors %}
            <div class="invalid-feedback d-block">{{ form.sender_type.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Sender Organization -->
          <div class="col-md-6">
            <label for="id_sender_org" class="form-label fw-semibold">Sender Organization</label>
            <input type="text"
                   id="id_sender_org"
                   name="sender_org"
                   class="form-control"
                   placeholder="Enter organization name"
                   value="{{ form.sender_org.value|default:'' }}">
            {% if form.sender_org.errors %}
            <div class="invalid-feedback d-block">{{ form.sender_org.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Sender Contact -->
          <div class="col-md-6">
            <label for="id_sender_contact" class="form-label fw-semibold">Sender Contact</label>
            <input type="text"
                   id="id_sender_contact"
                   name="sender_contact"
                   class="form-control"
                   placeholder="+1 (555) 123-4567 or email@example.com"
                   value="{{ form.sender_contact.value|default:'' }}">
            <div class="form-text">Phone number or email</div>
            {% if form.sender_contact.errors %}
            <div class="invalid-feedback d-block">{{ form.sender_contact.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Package Details Section -->
          <div class="col-12 mt-4">
            <h6 class="text-muted text-uppercase mb-3" style="font-size: 0.875rem; letter-spacing: 0.5px;">
              <i class="bi bi-box me-1"></i>Package Details
            </h6>
          </div>

          <!-- Item Type -->
          <div class="col-md-6">
            <label for="itemType" class="form-label fw-semibold">
              Item Type <span class="text-danger">*</span>
            </label>
            <select id="itemType" name="item_type" class="form-select select2-basic" required>
              <option value="">Select type</option>
              <option value="Document">Document</option>
              <option value="Parcel">Parcel</option>
              <option value="Box">Box</option>
              <option value="Envelope">Envelope</option>
              <option value="Electronics">Electronics</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <!-- Description -->
          <div class="col-md-6">
            <label for="id_description" class="form-label fw-semibold">Description</label>
            <input type="text"
                   id="id_description"
                   name="description"
                   class="form-control"
                   placeholder="e.g., Contract documents, USB drive, Medical supplies"
                   value="{{ form.description.value|default:'' }}">
            <div class="form-text">Brief description of contents</div>
            {% if form.description.errors %}
            <div class="invalid-feedback d-block">{{ form.description.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Notes -->
          <div class="col-12">
            <label for="id_notes" class="form-label fw-semibold">Additional Notes</label>
            <textarea id="id_notes"
                      name="notes"
                      class="form-control"
                      rows="3"
                      placeholder="Any special handling instructions, urgency level, or other relevant details...">{{ form.notes.value|default:'' }}</textarea>
            <div class="form-text">Any special handling instructions or additional information</div>
            {% if form.notes.errors %}
            <div class="invalid-feedback d-block">{{ form.notes.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Destination Section -->
          <div class="col-12 mt-4">
            <h6 class="text-muted text-uppercase mb-3" style="font-size: 0.875rem; letter-spacing: 0.5px;">
              <i class="bi bi-geo-alt me-1"></i>Destination Information
            </h6>
          </div>

          <!-- Destination Agency -->
          <div class="col-md-6">
            <label for="id_destination_agency" class="form-label fw-semibold">
              Destination Agency <span class="text-danger">*</span>
            </label>
            {{ form.destination_agency }}
          </div>

          <!-- Focal Point -->
          <div class="col-md-6">
            <label for="id_dest_focal_email" class="form-label fw-semibold">
              Destination Focal Point <span class="text-danger">*</span>
            </label>
            {{ form.dest_focal_email }}
            <div class="form-text">Primary contact person</div>
          </div>

          <!-- Recipient -->
          <div class="col-md-6">
            <label for="id_for_recipient" class="form-label fw-semibold">
              Recipient <span class="text-danger">*</span>
            </label>
            {{ form.for_recipient }}
            <div class="form-text">Final recipient of the package</div>
          </div>

        </div>

        <!-- Form Actions -->
        <div class="mt-4 pt-3 border-top d-flex gap-2">
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <i class="bi bi-send-check me-2"></i>Save & Send to Reception
          </button>
          <a href="{% url 'vehicles:package_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle me-2"></i>Cancel
          </a>
        </div>

      </form>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner-border text-light" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(function () {
  'use strict';

  // Initialize Select2
  $('.select2-basic').select2({
    width: '100%',
    theme: 'default',
    placeholder: function() {
      return $(this).data('placeholder') || 'Select an option';
    }
  });

  $('#id_destination_agency').select2({
    width: '100%',
    placeholder: "Select agency",
    allowClear: true
  });

  $('#id_dest_focal_email').select2({
    width: '100%',
    placeholder: "Select focal point",
    allowClear: true
  });

  $('#id_for_recipient').select2({
    width: '100%',
    placeholder: "Select recipient",
    allowClear: true
  });

  // Cache original options for filtering
  const allFocalOptions = $('#id_dest_focal_email option').clone();
  const allRecipientOptions = $('#id_for_recipient option').clone();

  /**
   * Filter users based on selected agency
   * Only shows users that belong to the selected agency
   */
  function filterUsers() {
    const agency = $('#id_destination_agency').val();

    function filterSelect(selectElement, allOptions) {
      const currentValue = selectElement.val();
      selectElement.empty();

      // Add blank option
      selectElement.append(new Option("", "", false, false));

      allOptions.each(function () {
        const txt = $(this).text();
        const val = $(this).val();

        if (!val) return;

        // Show all if no agency selected, or only matching agency options
        if (!agency || txt.startsWith(agency + " â€“") || txt.startsWith(agency + " -")) {
          selectElement.append($(this).clone());
        }
      });

      // Restore previous value if still valid
      if (currentValue && selectElement.find(`option[value="${currentValue}"]`).length) {
        selectElement.val(currentValue);
      } else {
        selectElement.val(null);
      }

      selectElement.trigger("change");
    }

    filterSelect($('#id_dest_focal_email'), allFocalOptions);
    filterSelect($('#id_for_recipient'), allRecipientOptions);
  }

  // Trigger filter on agency change
  $('#id_destination_agency').on('change', filterUsers);

  // Run on page load
  filterUsers();

  // Form submission handling
  $('#packageForm').on('submit', function(e) {
    const form = this;

    // HTML5 validation
    if (!form.checkValidity()) {
      e.preventDefault();
      e.stopPropagation();
      form.classList.add('was-validated');

      // Scroll to first error
      const firstInvalid = form.querySelector(':invalid');
      if (firstInvalid) {
        firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstInvalid.focus();
      }
      return false;
    }

    // Show loading overlay
    $('#loadingOverlay').addClass('active');
    $('#submitBtn').prop('disabled', true);
  });

  // Add Bootstrap validation classes to form controls
  $('.form-control, .form-select').on('blur', function() {
    if ($(this).val()) {
      $(this).removeClass('is-invalid');
    }
  });

  // Prevent multiple form submissions
  let formSubmitted = false;
  $('#packageForm').on('submit', function() {
    if (formSubmitted) {
      return false;
    }
    formSubmitted = true;
    return true;
  });
});
</script>
{% endblock %}