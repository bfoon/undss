{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Quick Vehicle Movement - UN Security Management System{% endblock %}

{% block extra_css %}
<style>
    .quick-card {
        border-left: 4px solid var(--un-blue);
        height: 100%;
    }

    .card-check {
        border-left: 4px solid var(--success-color);
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }

    .live-clock {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        color: var(--un-blue);
    }

    .plate-preview {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        text-transform: uppercase;
        color: var(--un-dark-blue);
    }

    .kbd-shortcut {
        background: var(--un-light-blue);
        color: var(--un-dark-blue);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        margin: 0 0.25rem;
    }

    .card-result {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        background: #f8f9fa;
    }

    .verification-success {
        border-color: var(--success-color);
        background: rgba(25, 135, 84, 0.05);
    }

    .verification-error {
        border-color: var(--danger-color);
        background: rgba(220, 53, 69, 0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center mb-4">
            <div>
                <h1 class="h3 mb-2">
                    <i class="bi bi-lightning-charge text-un-primary me-2"></i>
                    Quick Vehicle Movement
                </h1>
                <p class="text-muted mb-0">Fast entry system for gate security personnel</p>
            </div>
            <div class="mt-3 mt-lg-0">
                <div class="d-flex align-items-center gap-3">
                    <div class="d-flex align-items-center">
                        <span class="status-indicator bg-success"></span>
                        <small class="text-muted">System Online</small>
                    </div>
                    <div class="live-clock" id="current-time">--:--:--</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Parking Card Verification -->
    <div class="col-lg-5">
        <div class="card quick-card card-check">
            <div class="card-header">
                <h5>
                    <i class="bi bi-credit-card-2-front me-2"></i>
                    Parking Card Verification
                </h5>
            </div>
            <div class="card-body">
                <form id="card-verification-form" class="mb-3">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text">
                            <i class="bi bi-upc-scan"></i>
                        </span>
                        <input type="text"
                               class="form-control"
                               id="card-number-input"
                               placeholder="Scan or enter card number"
                               autocomplete="off">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-search me-1"></i>Verify
                        </button>
                    </div>
                    <div class="form-text">
                        <i class="bi bi-info-circle me-1"></i>
                        Scan barcode or manually enter the parking card number
                    </div>
                </form>

                <div id="card-verification-result" class="d-none">
                    <div class="card-result p-3" id="result-container">
                        <div class="alert mb-3" id="verification-status"></div>

                        <div class="row g-2" id="card-details">
                            <div class="col-6">
                                <div class="border rounded p-2 bg-white">
                                    <small class="text-muted d-block">Card Holder</small>
                                    <div class="fw-semibold" id="holder-name">—</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2 bg-white">
                                    <small class="text-muted d-block">Department</small>
                                    <div class="fw-semibold" id="department">—</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2 bg-white">
                                    <small class="text-muted d-block">Vehicle Plate</small>
                                    <div class="fw-semibold plate-preview" id="vehicle-plate">—</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2 bg-white">
                                    <small class="text-muted d-block">Expiry Date</small>
                                    <div class="fw-semibold" id="expiry-date">—</div>
                                </div>
                            </div>
                            <div class="col-12" id="contact-info">
                                <div class="border rounded p-2 bg-white">
                                    <small class="text-muted d-block">Contact Number</small>
                                    <div class="fw-semibold" id="contact-number">—</div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 mt-3">
                            <button class="btn btn-outline-secondary" id="clear-verification">
                                <i class="bi bi-arrow-clockwise me-1"></i>Clear & Scan Next
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-3 bg-light rounded">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-lightbulb text-warning me-2 mt-1"></i>
                        <div class="small">
                            <strong>Quick Tip:</strong> Valid parking cards will automatically populate
                            the vehicle plate in the movement form. Press
                            <span class="kbd-shortcut">Enter</span> after scanning for instant verification.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Movement Entry Form -->
    <div class="col-lg-7">
        <div class="card quick-card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5>
                        <i class="bi bi-arrow-left-right me-2"></i>
                        Movement Registration
                    </h5>
                    <div class="d-none d-md-flex align-items-center gap-2">
                        <small class="text-muted">Shortcuts:</small>
                        <span class="kbd-shortcut">E</span>
                        <small class="text-muted">Entry</small>
                        <span class="kbd-shortcut">X</span>
                        <small class="text-muted">Exit</small>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'vehicles:record_movement' %}" id="movement-form">
                    {% csrf_token %}
                    {{ movement_form|crispy }}

                    <div class="d-flex gap-2 mt-3">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle me-2"></i>Record Movement
                        </button>
                        <a href="{% url 'vehicles:movement_list' %}" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-list-ul me-2"></i>View Log
                        </a>
                    </div>
                </form>

                <!-- Live Preview -->
                <div class="row g-2 mt-4">
                    <div class="col-6">
                        <div class="border rounded p-3 text-center bg-light">
                            <small class="text-muted d-block">Current Time</small>
                            <div class="live-clock" id="form-time">--:--:--</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-3 text-center bg-light">
                            <small class="text-muted d-block">License Plate</small>
                            <div class="plate-preview" id="plate-preview">—</div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-3 bg-light rounded">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-shield-check text-success me-2 mt-1"></i>
                        <div class="small">
                            <strong>Security Note:</strong> Verify vehicle occupants match parking card
                            holder information. For visitor vehicles, ensure proper visitor clearance
                            before allowing entry.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Real-time clock updates
function updateClocks() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });

    document.getElementById('current-time').textContent = timeString;
    document.getElementById('form-time').textContent = timeString;
}

// Update clocks every second
setInterval(updateClocks, 1000);
updateClocks(); // Initial call

// Form elements
const cardInput = document.getElementById('card-number-input');
const cardForm = document.getElementById('card-verification-form');
const cardResult = document.getElementById('card-verification-result');
const clearBtn = document.getElementById('clear-verification');
const plateInput = document.getElementById('id_plate_number');
const platePreview = document.getElementById('plate-preview');
const movementType = document.getElementById('id_movement_type');

// Auto-uppercase and live preview for plate input
if (plateInput) {
    plateInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
        platePreview.textContent = this.value || '—';
    });

    // Submit form on Enter when focused on plate field
    plateInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('movement-form').submit();
        }
    });

    // Auto-focus for efficiency
    plateInput.focus();
}

// Keyboard shortcuts for movement type
document.addEventListener('keydown', function(e) {
    if (!movementType) return;

    // Ignore if typing in input fields
    const activeTag = document.activeElement?.tagName;
    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(activeTag)) return;

    if (e.key.toLowerCase() === 'e') {
        movementType.value = 'entry';
        e.preventDefault();
    } else if (e.key.toLowerCase() === 'x') {
        movementType.value = 'exit';
        e.preventDefault();
    }
});

// Parking card verification
async function verifyParkingCard(cardNumber) {
    const url = `{% url 'vehicles:validate_parking_card' %}?card_number=${encodeURIComponent(cardNumber)}`;

    try {
        // Show loading state
        showLoadingState();

        const response = await fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();

        cardResult.classList.remove('d-none');
        const container = document.getElementById('result-container');
        const status = document.getElementById('verification-status');

        if (data.valid) {
            container.className = 'card-result verification-success p-3';
            status.className = 'alert alert-success mb-3';
            status.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-check-circle-fill fs-5 me-2"></i>
                    <div>
                        <strong>Valid Parking Card</strong>
                        <div class="small">Card is active and authorized for use</div>
                    </div>
                </div>
            `;

            // Update card details
            document.getElementById('holder-name').textContent = data.owner_name || '—';
            document.getElementById('department').textContent = data.department || '—';
            document.getElementById('vehicle-plate').textContent = data.vehicle_plate || '—';
            document.getElementById('expiry-date').textContent = data.expiry_date || '—';
            document.getElementById('contact-number').textContent = data.phone || '—';

            // Auto-fill plate number if available
            if (plateInput && data.vehicle_plate) {
                plateInput.value = data.vehicle_plate.toUpperCase();
                platePreview.textContent = data.vehicle_plate.toUpperCase();
            }

        } else {
            container.className = 'card-result verification-error p-3';
            status.className = 'alert alert-danger mb-3';
            status.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-x-circle-fill fs-5 me-2"></i>
                    <div>
                        <strong>Invalid Parking Card</strong>
                        <div class="small">${data.error || 'Card not found or expired'}</div>
                    </div>
                </div>
            `;

            // Clear card details
            clearCardDetails();
        }

    } catch (error) {
        cardResult.classList.remove('d-none');
        const container = document.getElementById('result-container');
        const status = document.getElementById('verification-status');

        container.className = 'card-result verification-error p-3';
        status.className = 'alert alert-warning mb-3';
        status.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle-fill fs-5 me-2"></i>
                <div>
                    <strong>Verification Error</strong>
                    <div class="small">Unable to verify card. Please check connection and try again.</div>
                </div>
            </div>
        `;

        clearCardDetails();
    }
}

function showLoadingState() {
    cardResult.classList.remove('d-none');
    const container = document.getElementById('result-container');
    container.className = 'card-result p-3';
    container.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Verifying card...</span>
            </div>
            <div class="text-muted">Verifying parking card...</div>
        </div>
    `;
}

function clearCardDetails() {
    document.getElementById('holder-name').textContent = '—';
    document.getElementById('department').textContent = '—';
    document.getElementById('vehicle-plate').textContent = '—';
    document.getElementById('expiry-date').textContent = '—';
    document.getElementById('contact-number').textContent = '—';
}

// Card form submission
if (cardForm) {
    cardForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const cardNumber = cardInput.value.trim();
        if (cardNumber) {
            verifyParkingCard(cardNumber);
        }
    });

    // Auto-submit on Enter key
    cardInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            cardForm.requestSubmit();
        }
    });
}

// Clear verification results
if (clearBtn) {
    clearBtn.addEventListener('click', function(e) {
        e.preventDefault();
        cardInput.value = '';
        cardResult.classList.add('d-none');
        cardInput.focus();
    });
}

// Auto-focus card input when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (cardInput) {
        cardInput.focus();
    }
});
</script>
{% endblock %}