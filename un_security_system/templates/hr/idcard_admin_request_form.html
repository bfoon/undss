{% extends "base.html" %}
{% block title %}ID Card Request for Staff{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url 'accounts:idcard_request_list' %}">ID Card Requests</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">Request for Staff</li>
    </ol>
  </nav>

  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-lg-9 mx-auto">
      <div class="card shadow-sm border-primary">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-auto">
              <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center"
                   style="width: 56px; height: 56px;">
                <i class="bi bi-person-badge fs-3 text-primary"></i>
              </div>
            </div>
            <div class="col">
              <h3 class="mb-1">ID Card Request for Staff</h3>
              <p class="text-muted mb-0">
                <i class="bi bi-shield-check me-1"></i>
                Authorized personnel: LSA / SOC / Agency HR can initiate requests for any employee
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Form -->
  <div class="row">
    <div class="col-lg-9 mx-auto">

      <!-- Role Information Alert -->
      <div class="alert alert-info d-flex align-items-start mb-4">
        <i class="bi bi-info-circle-fill me-2 mt-1"></i>
        <div>
          <strong>Staff Request Guidelines:</strong>
          <ul class="mb-0 mt-2 small">
            <li>This form allows you to submit ID card requests on behalf of employees</li>
            <li>Ensure you have proper authorization to request cards for staff members</li>
            <li>Select the employee from the dropdown and provide complete information</li>
            <li>The employee will be notified once the request is processed</li>
          </ul>
        </div>
      </div>

      <div class="row g-4">
        <!-- Form Card -->
        <div class="col-lg-8">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="bi bi-pencil-square me-2"></i> Request Details
              </h5>
            </div>
            <div class="card-body p-4">
              <form method="post" novalidate id="staffIdCardRequestForm">
                {% csrf_token %}

                <!-- Display non-field errors -->
                {% if form.non_field_errors %}
                  <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Error:</strong>
                    <ul class="mb-0 mt-2">
                      {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                      {% endfor %}
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                  </div>
                {% endif %}

                <!-- Employee Selection -->
                {% if form.for_user %}
                  <div class="mb-4">
                    <label for="{{ form.for_user.id_for_label }}" class="form-label fw-semibold">
                      <i class="bi bi-person-circle me-1"></i> Select Employee
                      {% if form.for_user.field.required %}
                        <span class="text-danger">*</span>
                      {% endif %}
                    </label>
                    {{ form.for_user }}
                    <div class="form-text">
                      <i class="bi bi-search me-1"></i>
                      Search and select the employee who needs an ID card
                    </div>
                    {% if form.for_user.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.for_user.errors %}
                          <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                {% endif %}

                <!-- Request Type -->
                {% if form.request_type %}
                  <div class="mb-4">
                    <label for="{{ form.request_type.id_for_label }}" class="form-label fw-semibold">
                      <i class="bi bi-card-list me-1"></i> Request Type
                      {% if form.request_type.field.required %}
                        <span class="text-danger">*</span>
                      {% endif %}
                    </label>
                    {{ form.request_type }}
                    <div class="form-text">
                      <div class="d-flex flex-column gap-1 mt-2">
                        <span><strong>New:</strong> First-time ID card issuance</span>
                        <span><strong>Renewal:</strong> Expired or expiring card</span>
                        <span><strong>Replacement:</strong> Lost, stolen, or damaged card</span>
                      </div>
                    </div>
                    {% if form.request_type.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.request_type.errors %}
                          <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                {% endif %}

                <!-- Reason -->
                {% if form.reason %}
                  <div class="mb-4">
                    <label for="{{ form.reason.id_for_label }}" class="form-label fw-semibold">
                      <i class="bi bi-chat-left-text me-1"></i> Reason / Additional Notes
                      {% if form.reason.field.required %}
                        <span class="text-danger">*</span>
                      {% endif %}
                    </label>
                    {{ form.reason }}
                    <div class="form-text">
                      Provide detailed information about why this ID card is needed.
                      For replacements, specify if lost, stolen, or damaged.
                    </div>
                    {% if form.reason.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.reason.errors %}
                          <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                {% endif %}

                <!-- Any other fields not explicitly handled -->
                {% for field in form %}
                  {% if field.name != 'for_user' and field.name != 'request_type' and field.name != 'reason' %}
                    <div class="mb-4">
                      <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                        {{ field.label }}
                        {% if field.field.required %}
                          <span class="text-danger">*</span>
                        {% endif %}
                      </label>
                      {{ field }}
                      {% if field.help_text %}
                        <div class="form-text">{{ field.help_text }}</div>
                      {% endif %}
                      {% if field.errors %}
                        <div class="invalid-feedback d-block">
                          {% for error in field.errors %}
                            <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  {% endif %}
                {% endfor %}

                <!-- Required Fields Notice -->
                <div class="alert alert-light border mb-4">
                  <small class="text-muted">
                    <i class="bi bi-asterisk text-danger me-1"></i>
                    Fields marked with an asterisk (<span class="text-danger">*</span>) are required
                  </small>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                  <a href="{% url 'accounts:idcard_request_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Cancel
                  </a>
                  <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-send me-1"></i> Submit Request
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Sidebar Information -->
        <div class="col-lg-4">

          <!-- Quick Tips -->
          <div class="card shadow-sm mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">
                <i class="bi bi-lightbulb me-2"></i> Quick Tips
              </h6>
            </div>
            <div class="card-body">
              <div class="d-flex flex-column gap-3">
                <div class="d-flex">
                  <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                  <small>Verify employee details before submission</small>
                </div>
                <div class="d-flex">
                  <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                  <small>Choose the correct request type</small>
                </div>
                <div class="d-flex">
                  <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                  <small>Provide clear reasons for replacements</small>
                </div>
                <div class="d-flex">
                  <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                  <small>Employee will be notified automatically</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Workflow Info -->
          <div class="card shadow-sm mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">
                <i class="bi bi-diagram-3 me-2"></i> Workflow
              </h6>
            </div>
            <div class="card-body">
              <ol class="ps-3 mb-0 small">
                <li class="mb-2"><strong>Request Submitted</strong> - Your request is logged</li>
                <li class="mb-2"><strong>Photo Pending</strong> - Employee scheduled for photo</li>
                <li class="mb-2"><strong>Card Printed</strong> - Physical card is created</li>
                <li class="mb-0"><strong>Card Issued</strong> - Delivered to employee</li>
              </ol>
            </div>
          </div>

          <!-- Contact Info -->
          <div class="card shadow-sm border-primary">
            <div class="card-body">
              <h6 class="mb-3">
                <i class="bi bi-headset me-2"></i> Need Assistance?
              </h6>
              <div class="d-flex flex-column gap-2 small">
                <div>
                  <i class="bi bi-envelope text-primary me-2"></i>
                  <strong>Email:</strong> ict.gm@undp.org
                </div>
                <div>
                  <i class="bi bi-telephone text-primary me-2"></i>
                  <strong>Phone:</strong> Extension 1234
                </div>
                <div>
                  <i class="bi bi-clock text-primary me-2"></i>
                  <strong>Hours:</strong> Mon-Fri, 9:00-17:00
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Bulk Request Notice -->
      <div class="alert alert-warning mt-4">
        <div class="d-flex align-items-start">
          <i class="bi bi-info-circle-fill me-2 mt-1"></i>
          <div>
            <strong>Bulk Requests:</strong> Need to request cards for multiple employees?
            <a href="mailto:hr@organization.org" class="alert-link">Contact HR</a>
            for assistance with batch processing.
          </div>
        </div>
      </div>

    </div>
  </div>

</div>

<style>
  /* Form styling */
  .form-control, .form-select {
    border-radius: 0.375rem;
    border: 1px solid #ced4da;
    padding: 0.625rem 0.75rem;
  }

  .form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }

  .form-control.is-invalid, .form-select.is-invalid {
    border-color: #dc3545;
  }

  textarea.form-control {
    min-height: 120px;
    resize: vertical;
  }

  .invalid-feedback {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.875rem;
  }

  /* Required asterisk */
  .text-danger {
    font-weight: bold;
  }

  /* Sidebar cards */
  .col-lg-4 .card {
    position: sticky;
    top: 20px;
  }

  /* Workflow list styling */
  ol li strong {
    color: #0d6efd;
  }

  /* Alert links */
  .alert-link {
    font-weight: 600;
    text-decoration: underline;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Add Bootstrap validation classes to form fields
  const form = document.getElementById('staffIdCardRequestForm');
  const formControls = form.querySelectorAll('.form-control, .form-select');

  // Add Bootstrap classes to form fields with errors
  formControls.forEach(function(field) {
    if (field.classList.contains('is-invalid') || field.parentElement.querySelector('.invalid-feedback')) {
      field.classList.add('is-invalid');
    }
  });

  // Form submission handler
  form.addEventListener('submit', function(e) {
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
  });

  // Request type helper - dynamic placeholder
  const requestTypeField = document.querySelector('[name="request_type"]');
  const reasonField = document.querySelector('[name="reason"]');

  if (requestTypeField && reasonField) {
    requestTypeField.addEventListener('change', function() {
      switch(this.value) {
        case 'replacement':
          reasonField.placeholder = 'Specify if the card was lost, stolen, or damaged, and provide details...';
          break;
        case 'renewal':
          reasonField.placeholder = 'Provide reason for renewal (e.g., card is expiring, expired)...';
          break;
        case 'new':
          reasonField.placeholder = 'Explain why this employee needs their first ID card...';
          break;
        default:
          reasonField.placeholder = 'Provide detailed information about this request...';
      }
    });

    // Trigger on page load if value exists
    if (requestTypeField.value) {
      requestTypeField.dispatchEvent(new Event('change'));
    }
  }

  // Employee selection helper
  const employeeField = document.querySelector('[name="for_user"]');
  if (employeeField) {
    employeeField.addEventListener('change', function() {
      if (this.value) {
        const selectedOption = this.options[this.selectedIndex];
        console.log('Selected employee:', selectedOption.text);
      }
    });
  }
});
</script>
{% endblock %}