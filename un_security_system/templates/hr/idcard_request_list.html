{% extends "base.html" %}
{% block title %}ID Card Requests{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-1">
        <i class="bi bi-card-list me-2"></i> ID Card Requests
      </h3>
      <p class="small text-muted mb-0">
        Manage employee ID card requests for new cards, renewals, and replacements.
      </p>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'accounts:idcard_request_for_user' %}" class="btn btn-un-primary">
        <i class="bi bi-person-plus me-1"></i> New Request
      </a>
    </div>
  </div>

  <!-- Enhanced Filter Section -->
  <form method="get" class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <!-- Status Filter -->
        <div class="col-md-3">
          <label for="statusFilter" class="form-label small text-muted mb-1">Status</label>
          <select id="statusFilter" name="status" class="form-select">
            <option value="">All Statuses</option>
            <option value="submitted" {% if status_filter == 'submitted' %}selected{% endif %}>Submitted</option>
            <option value="photo_pending" {% if status_filter == 'photo_pending' %}selected{% endif %}>Photo Pending</option>
            <option value="printed" {% if status_filter == 'printed' %}selected{% endif %}>Printed</option>
            <option value="issued" {% if status_filter == 'issued' %}selected{% endif %}>Issued</option>
            <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
          </select>
        </div>

        <!-- Request Type Filter -->
        <div class="col-md-3">
          <label for="typeFilter" class="form-label small text-muted mb-1">Request Type</label>
          <select id="typeFilter" name="request_type" class="form-select">
            <option value="">All Types</option>
            <option value="new" {% if request_type_filter == 'new' %}selected{% endif %}>New Card</option>
            <option value="renewal" {% if request_type_filter == 'renewal' %}selected{% endif %}>Renewal</option>
            <option value="replacement" {% if request_type_filter == 'replacement' %}selected{% endif %}>Replacement</option>
          </select>
        </div>

        <!-- Search Filter -->
        <div class="col-md-4">
          <label for="searchFilter" class="form-label small text-muted mb-1">Search Employee</label>
          <input type="text" id="searchFilter" name="search" class="form-control"
                 placeholder="Name or username..." value="{{ search_filter }}">
        </div>

        <!-- Action Buttons -->
        <div class="col-md-2">
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-fill">
              <i class="bi bi-funnel me-1"></i> Filter
            </button>
            <a href="{% url 'accounts:idcard_request_list' %}" class="btn btn-outline-secondary" title="Clear filters">
              <i class="bi bi-x-lg"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- Statistics Cards (Optional) -->
  {% if show_stats %}
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card border-primary">
        <div class="card-body text-center">
          <h5 class="text-primary mb-0">{{ stats.submitted }}</h5>
          <small class="text-muted">Submitted</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-warning">
        <div class="card-body text-center">
          <h5 class="text-warning mb-0">{{ stats.photo_pending }}</h5>
          <small class="text-muted">Photo Pending</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-info">
        <div class="card-body text-center">
          <h5 class="text-info mb-0">{{ stats.printed }}</h5>
          <small class="text-muted">Printed</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-success">
        <div class="card-body text-center">
          <h5 class="text-success mb-0">{{ stats.issued }}</h5>
          <small class="text-muted">Issued</small>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Results Table -->
  {% if requests %}
    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <span class="fw-semibold">
          <i class="bi bi-table me-2"></i>{{ requests|length }} Request{{ requests|length|pluralize }}
        </span>
        {% if has_filters %}
          <span class="badge bg-primary">Filtered</span>
        {% endif %}
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Employee</th>
              <th>Agency</th>
              <th>Type</th>
              <th>Requested Date</th>
              <th>Requested By</th>
              <th>Status</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for r in requests %}
              <tr>
                <!-- Employee Name -->
                <td>
                  <div class="d-flex align-items-center">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2"
                         style="width: 32px; height: 32px;">
                      <i class="bi bi-person text-primary"></i>
                    </div>
                    <div>
                      <a href="{% url 'accounts:idcard_request_detail' r.pk %}" class="text-decoration-none fw-semibold">
                        {{ r.for_user.get_full_name|default:r.for_user.username }}
                      </a>
                      {% if r.for_user.email %}
                        <div class="small text-muted">{{ r.for_user.email }}</div>
                      {% endif %}
                    </div>
                  </div>
                </td>

                <!-- Agency -->
                <td>
                  {% if r.for_user.agency %}
                    <span class="badge bg-light text-dark">{{ r.for_user.agency.code }}</span>
                  {% else %}
                    <span class="text-muted">â€”</span>
                  {% endif %}
                </td>

                <!-- Request Type -->
                <td>
                  <span class="badge {% if r.request_type == 'new' %}bg-primary{% elif r.request_type == 'renewal' %}bg-info{% else %}bg-warning{% endif %}">
                    {{ r.get_request_type_display }}
                  </span>
                </td>

                <!-- Date -->
                <td>
                  <div class="small">{{ r.created_at|date:"M d, Y" }}</div>
                  <div class="text-muted" style="font-size: 0.75rem;">{{ r.created_at|date:"H:i" }}</div>
                </td>

                <!-- Requested By -->
                <td>
                  <div class="small">{{ r.requested_by.get_full_name|default:r.requested_by.username }}</div>
                </td>

                <!-- Status Badge -->
                <td>
                  <span class="badge
                    {% if r.status == 'submitted' %} bg-primary
                    {% elif r.status == 'photo_pending' %} bg-warning text-dark
                    {% elif r.status == 'printed' %} bg-info
                    {% elif r.status == 'issued' %} bg-success
                    {% elif r.status == 'rejected' %} bg-danger
                    {% else %} bg-secondary {% endif %}
                  ">
                    <i class="bi
                      {% if r.status == 'submitted' %}bi-file-earmark-check
                      {% elif r.status == 'photo_pending' %}bi-camera-video
                      {% elif r.status == 'printed' %}bi-printer
                      {% elif r.status == 'issued' %}bi-check-circle
                      {% elif r.status == 'rejected' %}bi-x-circle
                      {% endif %} me-1"></i>
                    {{ r.get_status_display }}
                  </span>
                </td>

                <!-- Action Buttons -->
                <td class="text-end">
                  <div class="btn-group btn-group-sm" role="group">
                    {% if r.status == "submitted" %}
                      <a href="{% url 'accounts:idcard_request_approve' r.pk %}"
                         class="btn btn-outline-primary" title="Call for Photo">
                        <i class="bi bi-camera-video"></i>
                      </a>
                      <a href="{% url 'accounts:idcard_request_reject' r.pk %}"
                         class="btn btn-outline-danger" title="Reject Request">
                        <i class="bi bi-x-circle"></i>
                      </a>

                    {% elif r.status == "photo_pending" %}
                      <a href="{% url 'accounts:idcard_request_mark_printed' r.pk %}"
                         class="btn btn-outline-success" title="Mark as Printed">
                        <i class="bi bi-printer"></i>
                      </a>

                    {% elif r.status == "printed" %}
                      <a href="{% url 'accounts:idcard_request_mark_issued' r.pk %}"
                         class="btn btn-un-primary" title="Mark as Issued">
                        <i class="bi bi-box-arrow-up-right"></i>
                      </a>

                    {% elif r.status == "issued" %}
                      <span class="badge bg-success-subtle text-success">
                        <i class="bi bi-check-circle-fill me-1"></i> Complete
                      </span>

                    {% elif r.status == "rejected" %}
                      <span class="badge bg-danger-subtle text-danger">
                        <i class="bi bi-x-octagon-fill me-1"></i> Rejected
                      </span>
                    {% endif %}

                    <a href="{% url 'accounts:idcard_request_detail' r.pk %}"
                       class="btn btn-outline-secondary" title="View Details">
                      <i class="bi bi-eye"></i>
                    </a>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination (if applicable) -->
      {% if is_paginated %}
      <div class="card-footer bg-white">
        <nav aria-label="Request pagination">
          <ul class="pagination pagination-sm mb-0 justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1{% if status_filter %}&status={{ status_filter }}{% endif %}">First</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}">Previous</a>
              </li>
            {% endif %}

            <li class="page-item active">
              <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            </li>

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}">Next</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if status_filter %}&status={{ status_filter }}{% endif %}">Last</a>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>

  {% else %}
    <div class="card shadow-sm">
      <div class="card-body text-center py-5">
        <i class="bi bi-inbox display-1 text-muted mb-3"></i>
        <h5 class="text-muted mb-2">No ID Card Requests Found</h5>
        <p class="text-muted mb-3">
          {% if has_filters %}
            No requests match your current filters. Try adjusting your search criteria.
          {% else %}
            There are currently no ID card requests in the system.
          {% endif %}
        </p>
        {% if has_filters %}
          <a href="{% url 'accounts:idcard_request_list' %}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-clockwise me-1"></i> Clear Filters
          </a>
        {% else %}
          <a href="{% url 'accounts:idcard_request_for_user' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i> Create First Request
          </a>
        {% endif %}
      </div>
    </div>
  {% endif %}

</div>

<style>
  .btn-group-sm > .btn {
    padding: 0.25rem 0.5rem;
  }

  .table td {
    vertical-align: middle;
  }

  .badge {
    font-weight: 500;
    padding: 0.35em 0.65em;
  }
</style>
{% endblock %}