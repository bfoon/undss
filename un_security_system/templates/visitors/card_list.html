{% extends "base.html" %}
{% block title %}Visitor Cards Management · UN Security{% endblock %}

{% block extra_css %}
<style>
  .stats-card {
    border: none;
    border-radius: 0.75rem;
    transition: all 0.3s;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .stats-card.available {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  }

  .stats-card.in-use {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  }

  .stats-card.inactive {
    background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
  }

  .stats-card .display-4 {
    font-size: 2.5rem;
    font-weight: 700;
  }

  .card-number {
    font-family: 'Courier New', monospace;
    font-weight: 700;
    font-size: 1.1rem;
    color: #0d6efd;
  }

  .status-badge {
    padding: 0.375rem 0.75rem;
    border-radius: 1rem;
    font-weight: 600;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
  }

  .badge-active { background: #d1e7dd; color: #0f5132; }
  .badge-inactive { background: #e2e3e5; color: #41464b; }
  .badge-in-use { background: #fff3cd; color: #856404; }
  .badge-available { background: #d1f4e0; color: #0f5132; }

  .filter-btn {
    transition: all 0.2s;
  }

  .filter-btn.active {
    background: #0d6efd;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
  }

  .table-hover tbody tr {
    transition: all 0.2s;
  }

  .table-hover tbody tr:hover {
    background: #f8f9fa;
    transform: scale(1.01);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  .search-container {
    position: relative;
  }

  .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
  }

  .search-input {
    padding-left: 2.75rem;
    border-radius: 2rem;
  }

  .empty-state {
    padding: 4rem 2rem;
    text-align: center;
  }

  .empty-state-icon {
    font-size: 4rem;
    color: #dee2e6;
    margin-bottom: 1rem;
  }

  .action-btn-sm {
    padding: 0.25rem 0.75rem;
    font-size: 0.875rem;
  }

  @media (max-width: 768px) {
    .stats-card .display-4 {
      font-size: 2rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px;">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-1"><i class="bi bi-credit-card-2-front-fill"></i> Visitor Cards Management</h3>
      <p class="text-muted mb-0">Track and manage visitor access cards</p>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-sm-6">
      <div class="card stats-card shadow-sm">
        <div class="card-body text-center">
          <div class="display-4 mb-2">{{ total_cards|default:0 }}</div>
          <div class="opacity-75">Total Cards</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card stats-card available shadow-sm">
        <div class="card-body text-center">
          <div class="display-4 mb-2">{{ available_cards|default:0 }}</div>
          <div class="opacity-75">Available</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card stats-card in-use shadow-sm">
        <div class="card-body text-center">
          <div class="display-4 mb-2">{{ in_use_cards|default:0 }}</div>
          <div class="opacity-75">In Use</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card stats-card inactive shadow-sm">
        <div class="card-body text-center">
          <div class="display-4 mb-2">{{ inactive_cards|default:0 }}</div>
          <div class="opacity-75">Inactive</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filter Bar -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-center">
        <div class="col-md-6">
          <form method="get" class="search-container">
            <i class="bi bi-search search-icon"></i>
            <input
              name="q"
              value="{{ q }}"
              class="form-control search-input"
              placeholder="Search by card number..."
              autocomplete="off">
          </form>
        </div>
        <div class="col-md-6">
          <div class="d-flex gap-2 flex-wrap">
            <span class="text-muted small align-self-center me-2">Filter:</span>
            <a href="?filter=all{% if q %}&q={{ q }}{% endif %}"
               class="btn btn-sm filter-btn {% if not filter or filter == 'all' %}active{% endif %}">
              <i class="bi bi-grid"></i> All
            </a>
            <a href="?filter=available{% if q %}&q={{ q }}{% endif %}"
               class="btn btn-sm filter-btn {% if filter == 'available' %}active{% endif %}">
              <i class="bi bi-check-circle"></i> Available
            </a>
            <a href="?filter=in_use{% if q %}&q={{ q }}{% endif %}"
               class="btn btn-sm filter-btn {% if filter == 'in_use' %}active{% endif %}">
              <i class="bi bi-exclamation-circle"></i> In Use
            </a>
            <a href="?filter=inactive{% if q %}&q={{ q }}{% endif %}"
               class="btn btn-sm filter-btn {% if filter == 'inactive' %}active{% endif %}">
              <i class="bi bi-x-circle"></i> Inactive
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cards Table -->
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="ps-4">
              <i class="bi bi-hash"></i> Card Number
            </th>
            <th>
              <i class="bi bi-toggle-on"></i> Status
            </th>
            <th>
              <i class="bi bi-person-badge"></i> Current Holder
            </th>
            <th>
              <i class="bi bi-clock"></i> Issued At
            </th>
            <th>
              <i class="bi bi-clock-history"></i> Returned At
            </th>
            <th class="text-end pe-4">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for c in cards %}
            <tr>
              <td class="ps-4">
                <span class="card-number">{{ c.number }}</span>
              </td>
              <td>
                <div class="d-flex flex-column gap-1">
                  {% if c.is_active %}
                    <span class="status-badge badge-active">
                      <i class="bi bi-check-circle-fill"></i> Active
                    </span>
                  {% else %}
                    <span class="status-badge badge-inactive">
                      <i class="bi bi-x-circle-fill"></i> Inactive
                    </span>
                  {% endif %}

                  {% if c.in_use %}
                    <span class="status-badge badge-in-use">
                      <i class="bi bi-exclamation-circle-fill"></i> In Use
                    </span>
                  {% else %}
                    <span class="status-badge badge-available">
                      <i class="bi bi-check-circle-fill"></i> Available
                    </span>
                  {% endif %}
                </div>
              </td>
              <td>
                {% if c.issued_to %}
                  <a href="{% url 'visitors:visitor_detail' c.issued_to_id %}" class="text-decoration-none">
                    <i class="bi bi-person-fill"></i> {{ c.issued_to.full_name }}
                  </a>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if c.issued_at %}
                  <div class="small">
                    <div class="fw-semibold">{{ c.issued_at|date:"M d, Y" }}</div>
                    <div class="text-muted">{{ c.issued_at|date:"H:i" }}</div>
                  </div>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if c.returned_at %}
                  <div class="small">
                    <div class="fw-semibold">{{ c.returned_at|date:"M d, Y" }}</div>
                    <div class="text-muted">{{ c.returned_at|date:"H:i" }}</div>
                  </div>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td class="text-end pe-4">
                <div class="btn-group btn-group-sm">
                  {% if c.issued_to %}
                    <a href="{% url 'visitors:visitor_detail' c.issued_to_id %}"
                       class="btn btn-outline-primary action-btn-sm"
                       title="View Visitor">
                      <i class="bi bi-eye"></i>
                    </a>
                  {% endif %}
                  {% if user.is_authenticated and user.role in 'lsa,soc,data_entry' or user.is_superuser %}
                    <button class="btn btn-outline-secondary action-btn-sm"
                            title="Edit Card"
                            onclick="alert('Edit card functionality')">
                      <i class="bi bi-pencil"></i>
                    </button>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="border-0">
                <div class="empty-state">
                  <div class="empty-state-icon">
                    <i class="bi bi-inbox"></i>
                  </div>
                  <h5 class="text-muted mb-2">No Cards Found</h5>
                  <p class="text-muted mb-3">
                    {% if q %}
                      No cards match your search "{{ q }}". Try a different search term.
                    {% else %}
                      There are no visitor cards in the system yet.
                    {% endif %}
                  </p>
                  {% if q %}
                    <a href="{% url 'visitors:visitor_cards' %}" class="btn btn-outline-primary">
                      <i class="bi bi-arrow-counterclockwise"></i> Clear Search
                    </a>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if cards %}
      <div class="card-footer bg-light">
        <div class="d-flex justify-content-between align-items-center">
          <div class="text-muted small">
            Showing {{ cards|length }} card{{ cards|length|pluralize }}
            {% if q %} matching "{{ q }}"{% endif %}
          </div>
          <div>
            <!-- Pagination could go here -->
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Help Card -->
  <div class="card border-0 bg-light mt-4">
    <div class="card-body">
      <div class="d-flex gap-3">
        <div class="text-primary">
          <i class="bi bi-info-circle-fill fs-4"></i>
        </div>
        <div>
          <h6 class="mb-2">About Visitor Cards</h6>
          <p class="text-muted small mb-0">
            Visitor access cards are issued during check-in and must be returned upon check-out.
            Cards marked as "Inactive" are not available for assignment.
            Use the search and filter options above to quickly find specific cards or view cards by status.
          </p>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  // Auto-submit search on input (with debounce)
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('.search-input');
    if (searchInput) {
      let debounceTimer;
      searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          this.form.submit();
        }, 500);
      });
    }
  });
</script>
{% endblock %}