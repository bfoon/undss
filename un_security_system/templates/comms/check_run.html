{% extends "base.html" %}
{% block title %}Radio Check — Run{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h3 class="mb-1">
        <i class="bi bi-activity me-2"></i> Radio Check
        {% if check.name %}<small class="text-muted">— {{ check.name }}</small>{% endif %}
      </h3>
      <div class="text-muted small">
        Started: {{ check.started_at|default:check.created_at|date:"M d, Y g:i A" }}
        {% if check.created_by %} · By {{ check.created_by.get_full_name|default:check.created_by.username }}{% endif %}
      </div>
      {% if check.notes %}
        <div class="mt-2 small text-muted">{{ check.notes }}</div>
      {% endif %}
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'comms:radios' %}">
        <i class="bi bi-arrow-left me-1"></i> Back to Radios
      </a>
      <a class="btn btn-outline-primary btn-sm" href="{% url 'comms:check_export_csv' check.pk %}">
        <i class="bi bi-filetype-csv me-1"></i> CSV
      </a>
      <a class="btn btn-outline-success btn-sm" href="{% url 'comms:check_export_xlsx' check.pk %}">
        <i class="bi bi-file-earmark-excel me-1"></i> Excel
      </a>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Summary cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded p-2 bg-light"><i class="bi bi-list-check fs-4"></i></div>
          <div>
            <div class="fw-semibold">Total</div>
            <div class="fs-5">{{ stats.total|default:lines|length }}</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded p-2 bg-light"><i class="bi bi-check2-circle fs-4 text-success"></i></div>
          <div>
            <div class="fw-semibold">Responded</div>
            <div class="fs-5 text-success">{{ stats.responded|default:0 }}</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded p-2 bg-light"><i class="bi bi-x-circle fs-4 text-danger"></i></div>
          <div>
            <div class="fw-semibold">No Response</div>
            <div class="fs-5 text-danger">{{ stats.missed|default:0 }}</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded p-2 bg-light"><i class="bi bi-hourglass-split fs-4 text-warning"></i></div>
          <div>
            <div class="fw-semibold">Pending</div>
            <div class="fs-5 text-warning">{{ stats.pending|default:0 }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter (client-side quick filter) -->
  <div class="card shadow-sm mb-3">
    <div class="card-body py-2">
      <div class="row g-2 align-items-center">
        <div class="col-md-6">
          <div class="input-group input-group-sm">
            <span class="input-group-text bg-white border-end-0">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" id="quickFilter" class="form-control border-start-0"
                   placeholder="Filter by call sign, user, or device...">
          </div>
        </div>
        <div class="col-md-6 text-md-end small text-muted">
          Click ✓ Responded or ✗ No Response to mark each line.
        </div>
      </div>
    </div>
  </div>

  <!-- Lines table -->
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table align-middle mb-0" id="linesTable">
        <thead class="table-light">
          <tr>
            <th style="width: 14%;">Call Sign</th>
            <th style="width: 26%;">Assigned To</th>
            <th style="width: 18%;">Device</th>
            <th style="width: 16%;">Band</th>
            <th style="width: 14%;">Responded</th>
            <th style="width: 12%;" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for line in lines %}
            {# Expected fields: line.status in ["pending","ok","missed"], line.responded_at, line.comment, line.device (with call_sign/owner/band/model/serial) #}
            <tr class="line-row"
                data-search="{{ line.device.call_sign|default_if_none:'' }} {{ line.device.owner.get_full_name|default:line.device.owner.username }} {{ line.device.model|default:'' }} {{ line.device.serial|default:'' }} {{ line.device.band|default:'' }}">
              <td>
                <strong>{{ line.device.call_sign|default:"—" }}</strong>
              </td>
              <td>
                {% if line.device.owner %}
                  {{ line.device.owner.get_full_name|default:line.device.owner.username }}
                  {% if line.device.owner.department %}
                    <div class="small text-muted">{{ line.device.owner.department }}</div>
                  {% endif %}
                {% else %}
                  <span class="text-muted">Unassigned</span>
                {% endif %}
              </td>
              <td>
                {{ line.device.model|default:"Radio" }}
                {% if line.device.serial %}<div class="small text-muted">S/N {{ line.device.serial }}</div>{% endif %}
              </td>
              <td>{{ line.device.band|upper|default:"—" }}</td>
              <td>
                {% if line.status == "ok" %}
                  <span class="badge bg-success-subtle text-success">
                    <i class="bi bi-check2-circle me-1"></i>Yes
                  </span>
                  {% if line.responded_at %}
                    <div class="small text-muted">{{ line.responded_at|date:"H:i" }}</div>
                  {% endif %}
                {% elif line.status == "missed" %}
                  <span class="badge bg-danger-subtle text-danger">
                    <i class="bi bi-x-circle me-1"></i>No
                  </span>
                {% else %}
                  <span class="badge bg-secondary-subtle text-secondary">Pending</span>
                {% endif %}
              </td>
              <td class="text-end">
                <div class="btn-group btn-group-sm" role="group">
                  <form method="post" action="{% url 'comms:check_mark' check.pk line.pk 'ok' %}">
                    {% csrf_token %}
                    <button class="btn btn-outline-success" title="Mark Responded">
                      <i class="bi bi-check2-circle"></i>
                    </button>
                  </form>
                  <form method="post" action="{% url 'comms:check_mark' check.pk line.pk 'missed' %}">
                    {% csrf_token %}
                    <button class="btn btn-outline-danger" title="Mark No Response">
                      <i class="bi bi-x-circle"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="text-center py-5">
                <div class="text-muted">
                  <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                  No participants in this check yet.
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<style>
  .badge.bg-success-subtle{ background-color: rgba(25,135,84,.1)!important; }
  .badge.bg-danger-subtle{ background-color: rgba(220,53,69,.1)!important; }
  .badge.bg-secondary-subtle{ background-color: rgba(108,117,125,.1)!important; }
</style>

<script>
  // Quick client-side filter
  document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('quickFilter');
    const rows = document.querySelectorAll('#linesTable tbody tr.line-row');
    if (!input) return;

    input.addEventListener('input', function () {
      const q = this.value.toLowerCase();
      let visible = 0;
      rows.forEach(r => {
        const hay = (r.getAttribute('data-search') || '').toLowerCase();
        const show = !q || hay.includes(q);
        r.style.display = show ? '' : 'none';
        if (show) visible++;
      });
    });
  });
</script>
{% endblock %}
