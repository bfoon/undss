{% extends "base.html" %}
{% load humanize %}

{% block extra_head %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- =========================
       PAGE HEADER
  ========================== -->
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-start gap-3 mb-4">
    <div class="flex-grow-1">
      <div class="d-flex align-items-center gap-2 flex-wrap mb-2">
        <h4 class="mb-0 text-dark fw-bold">Common Service Request</h4>
        <span class="badge bg-dark fs-6">CSR#{{ csr.id }}</span>

        {% if csr.incident %}
          <span class="badge bg-warning text-dark">
            <i class="bi bi-shield-exclamation me-1"></i>Linked Security Incident #{{ csr.incident.id }}
          </span>
        {% endif %}
      </div>

      <div class="mt-2">
        <h5 class="mb-2 fw-semibold text-primary">{{ csr.title }}</h5>
        <div class="text-muted small d-flex flex-wrap align-items-center gap-2">
          <span>
            <i class="bi bi-person-circle me-1"></i>
            <strong>{{ csr.requested_by.get_full_name|default:csr.requested_by.username }}</strong>
          </span>
          {% if csr.agency %}
            <span class="text-muted">•</span>
            <span>
              <i class="bi bi-building me-1"></i>
              <strong>{{ csr.agency.code|default:csr.agency.name }}</strong>
            </span>
          {% endif %}
          <span class="text-muted">•</span>
          <span>
            <i class="bi bi-clock me-1"></i>
            <strong>{{ csr.created_at|date:"d M Y, H:i" }}</strong>
          </span>
        </div>
      </div>
    </div>

    <div class="d-flex align-items-center gap-2 flex-wrap justify-content-lg-end">
      {% if csr.incident %}
        <a class="btn btn-outline-warning btn-sm"
           href="{% url 'incidents:incident_detail' csr.incident.pk %}"
           title="View linked security incident">
          <i class="bi bi-shield-check me-1"></i>View Incident
        </a>
      {% endif %}

      <a class="btn btn-outline-primary btn-sm"
         href="{% url 'incidents:csr_queue' %}"
         title="Return to CSR queue">
        <i class="bi bi-inbox me-1"></i>CSR Queue
      </a>

      <a class="btn btn-outline-secondary btn-sm"
         href="{% url 'incidents:my_csr' %}"
         title="View my service requests">
        <i class="bi bi-file-earmark-text me-1"></i>My Requests
      </a>
    </div>
  </div>

  <!-- =========================
       STATUS STRIP
  ========================== -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-center">

        <!-- Status -->
        <div class="col-md-4">
          <div class="d-flex align-items-center gap-2">
            <span class="text-muted small text-uppercase fw-semibold">Status:</span>
            <span class="badge fs-6
              {% if csr.status == 'new' %}bg-secondary
              {% elif csr.status == 'in_progress' %}bg-primary
              {% elif csr.status == 'completed' %}bg-success
              {% elif csr.status == 'cancelled' %}bg-dark
              {% else %}bg-secondary{% endif %}">
              <i class="bi
                {% if csr.status == 'new' %}bi-circle
                {% elif csr.status == 'in_progress' %}bi-arrow-repeat
                {% elif csr.status == 'completed' %}bi-check-circle
                {% elif csr.status == 'cancelled' %}bi-x-circle
                {% endif %} me-1"></i>
              {{ csr.get_status_display }}
            </span>
          </div>
        </div>

        <!-- Priority -->
        <div class="col-md-3">
          <div class="d-flex align-items-center gap-2">
            <span class="text-muted small text-uppercase fw-semibold">Priority:</span>
            <span class="badge fs-6
              {% if csr.priority == 'urgent' %}bg-danger
              {% elif csr.priority == 'high' %}bg-warning text-dark
              {% elif csr.priority == 'medium' %}bg-info text-dark
              {% else %}bg-light text-dark border{% endif %}">
              <i class="bi
                {% if csr.priority == 'urgent' %}bi-exclamation-triangle-fill
                {% elif csr.priority == 'high' %}bi-exclamation-circle-fill
                {% else %}bi-flag
                {% endif %} me-1"></i>
              {{ csr.get_priority_display }}
            </span>
          </div>
        </div>

        <!-- Category -->
        <div class="col-md-3">
          <div class="d-flex align-items-center gap-2">
            <span class="text-muted small text-uppercase fw-semibold">Category:</span>
            <span class="badge bg-light text-dark border fs-6">
              <i class="bi bi-tag me-1"></i>{{ csr.get_category_display }}
            </span>
          </div>
        </div>

        <!-- Notice Badge -->
        <div class="col-md-2">
          {% if csr.is_notice %}
            <span class="badge bg-info text-dark fs-6">
              <i class="bi bi-megaphone me-1"></i>Notice
            </span>
          {% endif %}
        </div>

      </div>

      <div class="text-end small text-muted mt-3 pt-2 border-top">
        <i class="bi bi-clock-history me-1"></i>
        Last updated: <strong>{{ csr.updated_at|date:"d M Y, H:i" }}</strong>
      </div>
    </div>
  </div>

  <div class="row g-4">

    <!-- =========================
         LEFT: DETAILS
    ========================== -->
    <div class="col-lg-8">

      <!-- Request Details Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-file-text text-primary me-2"></i>Request Details
          </h5>
          {% if csr.location %}
            <span class="badge bg-light text-dark border">
              <i class="bi bi-geo-alt me-1"></i>{{ csr.location }}
            </span>
          {% endif %}
        </div>

        <div class="card-body">

          <!-- Description -->
          <div class="mb-4">
            <div class="text-muted small text-uppercase fw-semibold mb-2">
              <i class="bi bi-card-text me-1"></i>Description
            </div>
            <div class="fs-6 lh-lg">{{ csr.description|linebreaks }}</div>
          </div>

          <!-- Facility Notice Alert -->
          {% if csr.is_notice %}
            <div class="alert alert-info border-info mb-4">
              <div class="d-flex gap-3">
                <div>
                  <i class="bi bi-info-circle-fill fs-4"></i>
                </div>
                <div class="flex-grow-1">
                  <h6 class="alert-heading fw-bold mb-2">
                    <i class="bi bi-megaphone me-1"></i>Facility Work / Disruption Notice
                  </h6>
                  <div class="small">
                    <div class="mb-1">
                      <strong>Start:</strong>
                      <span class="text-dark">{{ csr.disruption_start|date:"d M Y, H:i"|default:"Not specified" }}</span>
                    </div>
                    <div>
                      <strong>End:</strong>
                      <span class="text-dark">{{ csr.disruption_end|date:"d M Y, H:i"|default:"Not specified" }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}

          <!-- Attachment Section -->
          {% if csr.attachment %}
            <div class="mt-4 pt-4 border-top">
              <div class="text-muted small text-uppercase fw-semibold mb-3">
                <i class="bi bi-paperclip me-1"></i>Attachment
              </div>
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 p-3 bg-light rounded">
                <div class="d-flex align-items-center gap-2">
                  <i class="bi bi-file-earmark-arrow-down text-primary fs-4"></i>
                  <div>
                    <div class="fw-semibold">File attached</div>
                    <div class="small text-muted">Click to view or download</div>
                  </div>
                </div>
                <a class="btn btn-primary btn-sm"
                   href="{{ csr.attachment.url }}"
                   target="_blank"
                   rel="noopener noreferrer"
                   title="Open attachment in new tab">
                  <i class="bi bi-download me-1"></i>View / Download
                </a>
              </div>
            </div>
          {% endif %}

        </div>

        <!-- Status Update Section (for authorized users) -->
        {% if request.user.is_superuser or is_csm or csr.assigned_to_id == request.user.id %}
          <div class="card-footer bg-light">
            <div class="text-muted small text-uppercase fw-semibold mb-3">
              <i class="bi bi-gear me-1"></i>Update Status
            </div>

            <form method="post"
                  action="{% url 'incidents:cs_update_status' csr.pk %}"
                  class="d-flex flex-wrap gap-2"
                  onsubmit="return confirm('Are you sure you want to update the status of this request?');">
              {% csrf_token %}

              {% if csr.status == "new" %}
                <button class="btn btn-primary"
                        name="status"
                        value="in_progress"
                        type="submit">
                  <i class="bi bi-play-circle me-1"></i>Start Work
                </button>
                <button class="btn btn-outline-danger"
                        name="status"
                        value="cancelled"
                        type="submit">
                  <i class="bi bi-x-circle me-1"></i>Cancel Request
                </button>
              {% elif csr.status == "in_progress" %}
                <button class="btn btn-success"
                        name="status"
                        value="completed"
                        type="submit">
                  <i class="bi bi-check-circle me-1"></i>Mark as Completed
                </button>
                <button class="btn btn-outline-danger"
                        name="status"
                        value="cancelled"
                        type="submit">
                  <i class="bi bi-x-circle me-1"></i>Cancel Request
                </button>
              {% else %}
                <div class="alert alert-secondary mb-0 py-2">
                  <i class="bi bi-info-circle me-1"></i>
                  This request is <strong>{{ csr.get_status_display }}</strong> and cannot be modified.
                </div>
              {% endif %}
            </form>

            <div class="form-text mt-2">
              <i class="bi bi-shield-lock me-1"></i>
              Only the assigned fulfiller or Common Services Manager can update the workflow status.
            </div>
          </div>
        {% endif %}

      </div>

    </div>

    <!-- =========================
         RIGHT: ASSIGNMENT + ROUTING
    ========================== -->
    <div class="col-lg-4">

      <!-- Assignment Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-person-check text-primary me-2"></i>Assignment & Responsibility
          </h5>
        </div>

        <div class="card-body">

          <!-- Requested By -->
          <div class="mb-4 pb-3 border-bottom">
            <div class="text-muted small text-uppercase fw-semibold mb-2">
              <i class="bi bi-person-circle me-1"></i>Requested by
            </div>
            <div class="fw-semibold fs-6">
              {{ csr.requested_by.get_full_name|default:csr.requested_by.username }}
            </div>
            <div class="text-muted small">{{ csr.requested_by.email|default:"" }}</div>
          </div>

          <!-- Assigned To -->
          <div class="mb-4">
            <div class="text-muted small text-uppercase fw-semibold mb-2">
              <i class="bi bi-person-badge me-1"></i>Assigned to
            </div>
            {% if csr.assigned_to %}
              <div class="fw-semibold fs-6">
                {{ csr.assigned_to.get_full_name|default:csr.assigned_to.username }}
              </div>
              {% if csr.assigned_to.role %}
                <div class="text-muted small">
                  <i class="bi bi-briefcase me-1"></i>
                  {{ csr.assigned_to.get_role_display|default:csr.assigned_to.role }}
                </div>
              {% endif %}
              {% if csr.assigned_to.email %}
                <div class="text-muted small">
                  <i class="bi bi-envelope me-1"></i>
                  {{ csr.assigned_to.email }}
                </div>
              {% endif %}
            {% else %}
              <div class="text-muted fst-italic">
                <i class="bi bi-person-x me-1"></i>Not yet assigned
              </div>
            {% endif %}
          </div>

          <!-- Assignment Form (for managers) - Only if NOT completed/cancelled -->
          {% if can_manage %}
            {% if csr.status != 'completed' and csr.status != 'cancelled' %}
              <div class="pt-3 border-top">
                <form method="post"
                      action="{% url 'incidents:cs_assign' csr.pk %}"
                      onsubmit="return confirm('Are you sure you want to change the assignment?');">
                  {% csrf_token %}
                  <label class="form-label fw-semibold mb-2">
                    <i class="bi bi-arrow-left-right me-1"></i>Assign / Reassign
                  </label>

                  <select name="assigned_to"
                          id="assignUserSelect"
                          class="form-select mb-3"
                          required
                          aria-label="Select user to assign">
                    <option value="">— Select user —</option>
                    {% for u in assignable_users %}
                      <option value="{{ u.id }}"
                              {% if csr.assigned_to_id == u.id %}selected{% endif %}
                              data-role="{% if u.role %}{{ u.get_role_display|default:u.role }}{% endif %}"
                              data-agency="{% if u.agency and is_csm %}{{ u.agency.code|default:u.agency.name }}{% endif %}">
                        {{ u.get_full_name|default:u.username }}
                        {% if u.role %} - {{ u.get_role_display|default:u.role }}{% endif %}
                        {% if u.agency and is_csm %} ({{ u.agency.code|default:u.agency.name }}){% endif %}
                      </option>
                    {% endfor %}
                  </select>

                  <button class="btn btn-primary w-100" type="submit">
                    <i class="bi bi-person-check me-1"></i>Update Assignment
                  </button>

                  <div class="form-text mt-2">
                    <i class="bi bi-journal-check me-1"></i>
                    Assignment changes are auditable and will notify the responsible party.
                  </div>
                </form>
              </div>
            {% else %}
              <!-- Locked message for completed/cancelled requests -->
              <div class="pt-3 border-top">
                <div class="alert alert-secondary mb-0 py-2">
                  <i class="bi bi-lock-fill me-1"></i>
                  Assignment is locked. Request is <strong>{{ csr.get_status_display }}</strong>.
                </div>
              </div>
            {% endif %}
          {% endif %}

        </div>
      </div>

      <!-- Escalation Card -->
      <div class="card shadow-sm">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-diagram-3 text-primary me-2"></i>Escalation & Routing
          </h5>
        </div>

        <div class="card-body">

          <!-- Current Escalation Status -->
          <div class="mb-4 pb-3 border-bottom">

            <!-- Escalated Role -->
            <div class="mb-3">
              <div class="text-muted small text-uppercase fw-semibold mb-1">
                <i class="bi bi-arrow-up-circle me-1"></i>Escalated role
              </div>
              <div class="fs-6">
                {% if csr.escalated_to %}
                  <span class="badge bg-warning text-dark">{{ csr.escalated_to }}</span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </div>
            </div>

            <!-- Escalated User -->
            <div class="mb-3">
              <div class="text-muted small text-uppercase fw-semibold mb-1">
                <i class="bi bi-person-up me-1"></i>Escalated to user
              </div>
              {% if csr.escalated_to_user %}
                <div class="fw-semibold fs-6">
                  {{ csr.escalated_to_user.get_full_name|default:csr.escalated_to_user.username }}
                </div>
                {% if csr.escalated_to_user.role %}
                  <div class="text-muted small">
                    <i class="bi bi-briefcase me-1"></i>
                    {{ csr.escalated_to_user.get_role_display|default:csr.escalated_to_user.role }}
                  </div>
                {% endif %}
              {% else %}
                <div class="text-muted">—</div>
              {% endif %}
            </div>

            <!-- Escalation Timestamp -->
            <div class="mb-0">
              <div class="text-muted small text-uppercase fw-semibold mb-1">
                <i class="bi bi-clock-history me-1"></i>Escalated at
              </div>
              <div class="fs-6">
                {{ csr.escalated_at|date:"d M Y, H:i"|default:"—" }}
              </div>
            </div>

          </div>

          <!-- Escalation Form (for CSM/Superuser) - Only if NOT completed/cancelled -->
          {% if user.is_superuser or is_csm %}
            {% if csr.status != 'completed' and csr.status != 'cancelled' %}
              <div class="pt-3 border-top">
                <form method="post"
                      action="{% url 'incidents:cs_escalate' csr.pk %}"
                      id="escalationForm">
                  {% csrf_token %}

                  <label class="form-label fw-semibold mb-2">
                    <i class="bi bi-diagram-3 me-1"></i>Escalate Request
                  </label>

                  <!-- Escalate to Role -->
                  <div class="mb-3">
                    <label class="form-label small">Escalate to Role (Optional)</label>
                    <select name="escalate_to_role"
                            id="escalateRoleSelect"
                            class="form-select"
                            aria-label="Select role to escalate to">
                      <option value="">— No role escalation —</option>
                      <option value="ops_manager" {% if csr.escalated_to == 'ops_manager' %}selected{% endif %}>Operations Manager</option>
                      <option value="lsa" {% if csr.escalated_to == 'lsa' %}selected{% endif %}>LSA (Local Security Advisor)</option>
                      <option value="soc" {% if csr.escalated_to == 'soc' %}selected{% endif %}>SOC (Security Operations Center)</option>
                      <option value="ict" {% if csr.escalated_to == 'ict' %}selected{% endif %}>ICT Support</option>
                      <option value="facility_manager" {% if csr.escalated_to == 'facility_manager' %}selected{% endif %}>Facility Manager</option>
                      <option value="admin" {% if csr.escalated_to == 'admin' %}selected{% endif %}>Administration</option>
                      <option value="other" {% if csr.escalated_to == 'other' %}selected{% endif %}>Other</option>
                    </select>
                  </div>

                  <!-- Escalate to Specific User -->
                  <div class="mb-3">
                    <label class="form-label small">Escalate to User (Optional)</label>
                    <select name="escalate_to_user"
                            id="escalateUserSelect"
                            class="form-select"
                            aria-label="Select user to escalate to">
                      <option value="">— No specific user —</option>
                      {% for u in assignable_users %}
                        <option value="{{ u.id }}"
                                {% if csr.escalated_to_user_id == u.id %}selected{% endif %}
                                data-role="{% if u.role %}{{ u.get_role_display|default:u.role }}{% endif %}"
                                data-agency="{% if u.agency %}{{ u.agency.code|default:u.agency.name }}{% endif %}">
                          {{ u.get_full_name|default:u.username }}
                          {% if u.role %} - {{ u.get_role_display|default:u.role }}{% endif %}
                          {% if u.agency %} ({{ u.agency.code|default:u.agency.name }}){% endif %}
                        </option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="d-grid gap-2">
                    <button class="btn btn-warning" type="submit">
                      <i class="bi bi-arrow-up-circle me-1"></i>Escalate Request
                    </button>

                    {% if csr.escalated_to or csr.escalated_to_user %}
                      <button class="btn btn-outline-secondary btn-sm"
                              type="submit"
                              onclick="return confirm('Are you sure you want to clear the escalation?');">
                        <i class="bi bi-x-circle me-1"></i>Clear Escalation
                      </button>
                    {% endif %}
                  </div>

                  <div class="form-text mt-2">
                    <i class="bi bi-info-circle me-1"></i>
                    Escalation routes this request for priority attention. The escalated user will be notified.
                  </div>
                </form>
              </div>
            {% else %}
              <!-- Locked message for completed/cancelled requests -->
              <div class="pt-3 border-top">
                <div class="alert alert-secondary mb-0 py-2">
                  <i class="bi bi-lock-fill me-1"></i>
                  Escalation is locked. Request is <strong>{{ csr.get_status_display }}</strong>.
                </div>
              </div>
            {% endif %}
          {% endif %}

          <!-- Escalation Alert -->
          {% if csr.escalated_to or csr.escalated_to_user %}
            <div class="alert alert-warning border-warning mt-4 mb-0">
              <div class="d-flex gap-2">
                <div>
                  <i class="bi bi-exclamation-triangle-fill"></i>
                </div>
                <div class="small">
                  <strong class="d-block mb-1">Escalated Request</strong>
                  This request has been escalated and requires priority attention.
                  Please action in line with your queue responsibilities.
                </div>
              </div>
            </div>
          {% endif %}

        </div>
      </div>

    </div>
  </div>

</div>

<!-- Custom Styles -->
<style>
  .card {
    border: none;
  }

  .card-header {
    border-bottom: 2px solid #e9ecef;
  }

  .badge {
    padding: 0.5rem 0.75rem;
    font-weight: 500;
  }

  .btn {
    font-weight: 500;
  }

  .form-select:focus,
  .btn:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
  }

  /* Select2 Bootstrap 5 Theme Customization */
  .select2-container--bootstrap-5 .select2-selection {
    min-height: 38px;
  }

  .select2-container--bootstrap-5 .select2-selection--single {
    padding: 0.375rem 0.75rem;
  }
</style>

{% endblock %}

{% block extra_js %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
  // Initialize Select2 on assignment dropdown
  $('#assignUserSelect').select2({
    theme: 'bootstrap-5',
    placeholder: '— Select user —',
    allowClear: true,
    width: '100%',
    templateResult: formatUserOption,
    templateSelection: formatUserSelection
  });

  // Initialize Select2 on escalation role dropdown
  $('#escalateRoleSelect').select2({
    theme: 'bootstrap-5',
    placeholder: '— No role escalation —',
    allowClear: true,
    width: '100%'
  });

  // Initialize Select2 on escalation user dropdown
  $('#escalateUserSelect').select2({
    theme: 'bootstrap-5',
    placeholder: '— No specific user —',
    allowClear: true,
    width: '100%',
    templateResult: formatUserOption,
    templateSelection: formatUserSelection
  });

  // Format user options with role and agency info
  function formatUserOption(user) {
    if (!user.id) {
      return user.text;
    }

    var $user = $(
      '<div class="d-flex flex-column">' +
        '<div class="fw-semibold">' + user.text.split(' - ')[0] + '</div>' +
        '<div class="small text-muted">' + (user.element.dataset.role || '') +
        (user.element.dataset.agency ? ' • ' + user.element.dataset.agency : '') + '</div>' +
      '</div>'
    );

    return $user;
  }

  function formatUserSelection(user) {
    return user.text.split(' - ')[0] || user.text;
  }
});
</script>
{% endblock %}