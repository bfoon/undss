{% extends "base.html" %}
{% load humanize %}

{% block content %}
<div class="container-fluid py-4">

  <!-- =========================
       PAGE HEADER
  ========================== -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
    <div>
      <h4 class="mb-1 fw-bold text-dark">
        <i class="bi bi-speedometer2 text-primary me-2"></i>
        Common Service Requests Dashboard
      </h4>
      <p class="text-muted mb-0">
        <i class="bi bi-info-circle me-1"></i>
        Comprehensive overview and management of all CSR activities
      </p>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'incidents:csr_queue' %}" 
         class="btn btn-outline-primary"
         title="View fulfiller queue">
        <i class="bi bi-inbox me-1"></i>Fulfiller Queue
      </a>
      <a href="{% url 'incidents:cs_support' %}" 
         class="btn btn-primary"
         title="Submit new request">
        <i class="bi bi-plus-circle me-1"></i>New Request
      </a>
    </div>
  </div>

  <!-- =========================
       FILTERS
  ========================== -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        
        <div class="col-md-4">
          <label class="form-label small fw-semibold text-muted">
            <i class="bi bi-building me-1"></i>Agency Filter
          </label>
          <select name="agency" class="form-select">
            <option value="">All Agencies</option>
            {% for agency in agencies %}
              <option value="{{ agency.id }}" {% if selected_agency == agency.id|stringformat:"s" %}selected{% endif %}>
                {{ agency.code|default:agency.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label small fw-semibold text-muted">
            <i class="bi bi-calendar-range me-1"></i>Date Range
          </label>
          <select name="range" class="form-select">
            <option value="7" {% if date_range_days == 7 %}selected{% endif %}>Last 7 days</option>
            <option value="30" {% if date_range_days == 30 %}selected{% endif %}>Last 30 days</option>
            <option value="90" {% if date_range_days == 90 %}selected{% endif %}>Last 90 days</option>
            <option value="180" {% if date_range_days == 180 %}selected{% endif %}>Last 6 months</option>
            <option value="365" {% if date_range_days == 365 %}selected{% endif %}>Last year</option>
            <option value="0" {% if date_range_days == 0 %}selected{% endif %}>All time</option>
          </select>
        </div>

        <div class="col-md-4">
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh Data
          </button>
        </div>

      </form>
    </div>
  </div>

  <!-- =========================
       KEY METRICS - OVERVIEW CARDS
  ========================== -->
  <div class="row g-3 mb-4">
    
    <!-- Total Requests -->
    <div class="col-md-6 col-xl-3">
      <div class="card shadow-sm border-0 border-start border-primary border-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-muted small fw-semibold text-uppercase mb-1">Total Requests</div>
              <div class="fs-2 fw-bold text-dark">{{ total_requests|intcomma }}</div>
              <div class="small text-muted mt-1">
                <i class="bi bi-clock-history me-1"></i>
                {{ total_filtered|intcomma }} in last {{ date_range_days }} days
              </div>
            </div>
            <div class="bg-primary bg-opacity-10 rounded-circle p-3">
              <i class="bi bi-inbox-fill fs-3 text-primary"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pending New -->
    <div class="col-md-6 col-xl-3">
      <div class="card shadow-sm border-0 border-start border-warning border-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-muted small fw-semibold text-uppercase mb-1">Pending New</div>
              <div class="fs-2 fw-bold text-warning">{{ pending_new|intcomma }}</div>
              <div class="small text-muted mt-1">
                <i class="bi bi-exclamation-circle me-1"></i>
                Awaiting assignment
              </div>
            </div>
            <div class="bg-warning bg-opacity-10 rounded-circle p-3">
              <i class="bi bi-circle-fill fs-3 text-warning"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Urgent Open -->
    <div class="col-md-6 col-xl-3">
      <div class="card shadow-sm border-0 border-start border-danger border-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-muted small fw-semibold text-uppercase mb-1">Urgent Open</div>
              <div class="fs-2 fw-bold text-danger">{{ urgent_open|intcomma }}</div>
              <div class="small text-muted mt-1">
                <i class="bi bi-exclamation-triangle-fill me-1"></i>
                Requires immediate attention
              </div>
            </div>
            <div class="bg-danger bg-opacity-10 rounded-circle p-3">
              <i class="bi bi-exclamation-triangle-fill fs-3 text-danger"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Avg Resolution Time -->
    <div class="col-md-6 col-xl-3">
      <div class="card shadow-sm border-0 border-start border-success border-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-muted small fw-semibold text-uppercase mb-1">Avg Resolution</div>
              <div class="fs-2 fw-bold text-success">
                {% if avg_resolution_hours > 0 %}
                  {{ avg_resolution_hours|floatformat:1 }}h
                {% else %}
                  —
                {% endif %}
              </div>
              <div class="small text-muted mt-1">
                <i class="bi bi-clock me-1"></i>
                Last 30 days
              </div>
            </div>
            <div class="bg-success bg-opacity-10 rounded-circle p-3">
              <i class="bi bi-speedometer fs-3 text-success"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- =========================
       STATUS & PRIORITY BREAKDOWN
  ========================== -->
  <div class="row g-3 mb-4">
    
    <!-- Status Breakdown -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-white py-3">
          <h6 class="mb-0 fw-bold">
            <i class="bi bi-pie-chart text-primary me-2"></i>
            Requests by Status
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-6">
              <div class="d-flex align-items-center gap-3 p-3 bg-light rounded">
                <div class="bg-secondary bg-opacity-10 rounded-circle p-2">
                  <i class="bi bi-circle-fill text-secondary fs-4"></i>
                </div>
                <div>
                  <div class="text-muted small">New</div>
                  <div class="fs-4 fw-bold">{{ status_stats.new|intcomma }}</div>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="d-flex align-items-center gap-3 p-3 bg-light rounded">
                <div class="bg-primary bg-opacity-10 rounded-circle p-2">
                  <i class="bi bi-arrow-repeat text-primary fs-4"></i>
                </div>
                <div>
                  <div class="text-muted small">In Progress</div>
                  <div class="fs-4 fw-bold">{{ status_stats.in_progress|intcomma }}</div>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="d-flex align-items-center gap-3 p-3 bg-light rounded">
                <div class="bg-success bg-opacity-10 rounded-circle p-2">
                  <i class="bi bi-check-circle-fill text-success fs-4"></i>
                </div>
                <div>
                  <div class="text-muted small">Completed</div>
                  <div class="fs-4 fw-bold">{{ status_stats.completed|intcomma }}</div>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="d-flex align-items-center gap-3 p-3 bg-light rounded">
                <div class="bg-dark bg-opacity-10 rounded-circle p-2">
                  <i class="bi bi-x-circle-fill text-dark fs-4"></i>
                </div>
                <div>
                  <div class="text-muted small">Cancelled</div>
                  <div class="fs-4 fw-bold">{{ status_stats.cancelled|intcomma }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Priority Breakdown -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-white py-3">
          <h6 class="mb-0 fw-bold">
            <i class="bi bi-flag-fill text-primary me-2"></i>
            Requests by Priority
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-6">
              <div class="d-flex align-items-center gap-3 p-3 bg-light rounded">
                <div class="bg-danger bg-opacity-10 rounded-circle p-2">
                  <i class="bi bi-exclamation-triangle-fill text-danger fs-4"></i>
                </div>
                <div>
                  <div class="text-muted small">Urgent</div>
                  <div class="fs-4 fw-bold">{{ priority_stats.urgent|intcomma }}</div>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="d-flex align-items-center gap-3 p-3 bg-light rounded">
                <div class="bg-warning bg-opacity-10 rounded-circle p-2">
                  <i class="bi bi-exclamation-circle-fill text-warning fs-4"></i>
                </div>
                <div>
                  <div class="text-muted small">High</div>
                  <div class="fs-4 fw-bold">{{ priority_stats.high|intcomma }}</div>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="d-flex align-items-center gap-3 p-3 bg-light rounded">
                <div class="bg-info bg-opacity-10 rounded-circle p-2">
                  <i class="bi bi-flag-fill text-info fs-4"></i>
                </div>
                <div>
                  <div class="text-muted small">Medium</div>
                  <div class="fs-4 fw-bold">{{ priority_stats.medium|intcomma }}</div>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="d-flex align-items-center gap-3 p-3 bg-light rounded">
                <div class="bg-secondary bg-opacity-10 rounded-circle p-2">
                  <i class="bi bi-flag text-secondary fs-4"></i>
                </div>
                <div>
                  <div class="text-muted small">Low</div>
                  <div class="fs-4 fw-bold">{{ priority_stats.low|intcomma }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- =========================
       ACTIONABLE ITEMS
  ========================== -->
  <div class="card shadow-sm mb-4 border-warning border-2">
    <div class="card-header bg-warning bg-opacity-10 py-3">
      <h6 class="mb-0 fw-bold">
        <i class="bi bi-bell-fill text-warning me-2"></i>
        Actionable Items
      </h6>
    </div>
    <div class="card-body">
      <div class="row g-3">
        
        <div class="col-md-3">
          <div class="border rounded p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="text-muted small mb-1">Unassigned Requests</div>
                <div class="fs-3 fw-bold text-danger">{{ unassigned }}</div>
              </div>
              <a href="{% url 'incidents:csr_queue' %}?status=new" 
                 class="btn btn-sm btn-outline-danger">
                <i class="bi bi-arrow-right"></i>
              </a>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="border rounded p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="text-muted small mb-1">New Requests</div>
                <div class="fs-3 fw-bold text-warning">{{ pending_new }}</div>
              </div>
              <a href="{% url 'incidents:csr_queue' %}?status=new" 
                 class="btn btn-sm btn-outline-warning">
                <i class="bi bi-arrow-right"></i>
              </a>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="border rounded p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="text-muted small mb-1">Escalated</div>
                <div class="fs-3 fw-bold text-primary">{{ escalated }}</div>
              </div>
              <a href="{% url 'incidents:csr_queue' %}" 
                 class="btn btn-sm btn-outline-primary">
                <i class="bi bi-arrow-right"></i>
              </a>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="border rounded p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="text-muted small mb-1">In Progress</div>
                <div class="fs-3 fw-bold text-info">{{ status_stats.in_progress }}</div>
              </div>
              <a href="{% url 'incidents:csr_queue' %}?status=in_progress" 
                 class="btn btn-sm btn-outline-info">
                <i class="bi bi-arrow-right"></i>
              </a>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- =========================
       TOP CATEGORIES & RECENT ACTIVITY
  ========================== -->
  <div class="row g-3 mb-4">
    
    <!-- Top Categories -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-white py-3">
          <h6 class="mb-0 fw-bold">
            <i class="bi bi-bar-chart text-primary me-2"></i>
            Top Service Categories
          </h6>
        </div>
        <div class="card-body">
          {% if category_stats %}
            <div class="list-group list-group-flush">
              {% for cat in category_stats %}
                <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                  <div class="flex-grow-1">
                    <div class="fw-semibold">
                      {% for value, label in csr_model.Category.choices %}
                        {% if value == cat.category %}{{ label }}{% endif %}
                      {% endfor %}
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                      {% widthratio cat.count total_requests 100 as percentage %}
                      <div class="progress-bar bg-primary" 
                           style="width: {{ percentage }}%"
                           role="progressbar" 
                           aria-valuenow="{{ percentage }}" 
                           aria-valuemin="0" 
                           aria-valuemax="100"></div>
                    </div>
                  </div>
                  <span class="badge bg-primary ms-3">{{ cat.count }}</span>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted text-center py-4">
              <i class="bi bi-inbox fs-1 opacity-50"></i>
              <p class="small mb-0 mt-2">No data available</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
          <h6 class="mb-0 fw-bold">
            <i class="bi bi-clock-history text-primary me-2"></i>
            Recent Activity
          </h6>
          <a href="{% url 'incidents:csr_queue' %}" class="btn btn-sm btn-outline-primary">
            View All
          </a>
        </div>
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th class="fw-semibold small">Ref</th>
                <th class="fw-semibold small">Title</th>
                <th class="fw-semibold small">Status</th>
                <th class="fw-semibold small">Priority</th>
                <th class="fw-semibold small">Created</th>
              </tr>
            </thead>
            <tbody>
              {% for csr in recent_requests %}
              <tr>
                <td>
                  <a href="{% url 'incidents:cs_detail' csr.id %}" 
                     class="badge bg-dark text-decoration-none">
                    CSR#{{ csr.id }}
                  </a>
                </td>
                <td>
                  <a href="{% url 'incidents:cs_detail' csr.id %}" 
                     class="text-decoration-none">
                    {{ csr.title|truncatewords:8 }}
                  </a>
                </td>
                <td>
                  <span class="badge
                    {% if csr.status == 'new' %}bg-secondary
                    {% elif csr.status == 'in_progress' %}bg-primary
                    {% elif csr.status == 'completed' %}bg-success
                    {% else %}bg-dark{% endif %}">
                    {{ csr.get_status_display }}
                  </span>
                </td>
                <td>
                  <span class="badge
                    {% if csr.priority == 'urgent' %}bg-danger
                    {% elif csr.priority == 'high' %}bg-warning text-dark
                    {% elif csr.priority == 'medium' %}bg-info text-dark
                    {% else %}bg-light text-dark{% endif %}">
                    {{ csr.get_priority_display }}
                  </span>
                </td>
                <td class="small text-muted">
                  {{ csr.created_at|date:"d M, H:i" }}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted py-4">
                  No recent activity
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- =========================
       AGENCY BREAKDOWN
  ========================== -->
  {% if agency_breakdown %}
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white py-3">
      <h6 class="mb-0 fw-bold">
        <i class="bi bi-building text-primary me-2"></i>
        Agency Breakdown
      </h6>
    </div>
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th class="fw-semibold">Agency</th>
            <th class="fw-semibold text-center">Total</th>
            <th class="fw-semibold text-center">New</th>
            <th class="fw-semibold text-center">In Progress</th>
            <th class="fw-semibold text-center">Completed</th>
            <th class="fw-semibold">Distribution</th>
          </tr>
        </thead>
        <tbody>
          {% for item in agency_breakdown %}
            {% if item.total > 0 %}
            <tr>
              <td>
                <div class="fw-semibold">{{ item.agency.code|default:item.agency.name }}</div>
                <div class="text-muted small">{{ item.agency.name }}</div>
              </td>
              <td class="text-center">
                <span class="badge bg-dark">{{ item.total }}</span>
              </td>
              <td class="text-center">
                {% if item.new > 0 %}
                  <span class="badge bg-secondary">{{ item.new }}</span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td class="text-center">
                {% if item.in_progress > 0 %}
                  <span class="badge bg-primary">{{ item.in_progress }}</span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td class="text-center">
                {% if item.completed > 0 %}
                  <span class="badge bg-success">{{ item.completed }}</span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                <div class="progress" style="height: 20px;">
                  {% widthratio item.total total_requests 100 as percentage %}
                  <div class="progress-bar bg-primary" 
                       style="width: {{ percentage }}%"
                       role="progressbar">
                    {{ percentage }}%
                  </div>
                </div>
              </td>
            </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

</div>

<!-- Custom Styles -->
<style>
  .card {
    border: none;
  }

  .card-header {
    border-bottom: 2px solid #e9ecef;
  }

  .badge {
    font-weight: 500;
  }

  .progress {
    background-color: #e9ecef;
  }

  .table td {
    padding: 0.75rem;
  }

  /* Hover effects */
  .card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease;
  }

  .table-hover tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.05);
  }
</style>

{% endblock %}
