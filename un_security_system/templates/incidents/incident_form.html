{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Report Security Incident - Incident Management{% endblock %}

{% block content %}
<div class="incident-report-container">
  <div class="container-fluid px-4 py-4" style="max-width: 1000px;">

    <!-- Header Section -->
    <div class="page-header mb-4">
      <div class="row align-items-center">
        <div class="col-md-8">
          <nav aria-label="breadcrumb" class="mb-2">
            <ol class="breadcrumb mb-0">
              <li class="breadcrumb-item"><a href="/">Home</a></li>
              <li class="breadcrumb-item"><a href="{% url 'incidents:my_incidents' %}">My Incidents</a></li>
              <li class="breadcrumb-item active" aria-current="page">Report Incident</li>
            </ol>
          </nav>
          <h2 class="page-title mb-1">
            <i class="bi bi-shield-exclamation text-danger me-2"></i>
            Report Security Incident
          </h2>
          <p class="text-muted mb-0">Document and submit a security incident report</p>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <a class="btn btn-outline-secondary" href="{% url 'incidents:my_incidents' %}">
            <i class="bi bi-list-ul me-2"></i>My Incidents
          </a>
        </div>
      </div>
    </div>

    <!-- Alert Messages -->
    {% if messages %}
      <div class="alerts-container mb-4">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-{% if message.tags == 'success' %}check-circle-fill{% elif message.tags == 'danger' %}exclamation-circle-fill{% else %}info-circle-fill{% endif %} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Info Alert -->
    <div class="alert alert-info shadow-sm mb-4" role="alert">
      <div class="d-flex align-items-start">
        <div class="alert-icon me-3">
          <i class="bi bi-info-circle-fill fs-4"></i>
        </div>
        <div>
          <h6 class="alert-heading mb-2">Important Information</h6>
          <p class="mb-0 small">
            All incident reports are treated confidentially and reviewed by security personnel.
            Please provide as much detail as possible to help us investigate and respond appropriately.
          </p>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <!-- Main Form Column -->
      <div class="col-lg-8">
        <!-- Form Card -->
        <div class="card form-card shadow-sm">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="bi bi-file-text me-2"></i>Incident Details
            </h5>
          </div>
          <div class="card-body p-4">
            <form method="post" enctype="multipart/form-data" id="incidentForm" novalidate>
              {% csrf_token %}

              <!-- Basic Information Section -->
              <div class="form-section">
                <h6 class="section-title">
                  <i class="bi bi-info-circle me-2"></i>Basic Information
                </h6>
                <div class="row g-3">
                  <div class="col-md-8">
                    {{ form.title|as_crispy_field }}
                  </div>
                  <div class="col-md-4">
                    {{ form.severity|as_crispy_field }}
                  </div>
                </div>
              </div>

              <!-- Classification Section -->
              <div class="form-section">
                <h6 class="section-title">
                  <i class="bi bi-tags me-2"></i>Classification
                </h6>
                <div class="row g-3">
                  <div class="col-md-6">
                    {{ form.category|as_crispy_field }}
                  </div>
                  <div class="col-md-6">
                    {{ form.location|as_crispy_field }}
                  </div>
                </div>
              </div>

              <!-- Time & Description Section -->
              <div class="form-section">
                <h6 class="section-title">
                  <i class="bi bi-clock-history me-2"></i>Time & Details
                </h6>
                <div class="row g-3">
                  <div class="col-md-6">
                    {{ form.occurred_at|as_crispy_field }}
                  </div>
                  <div class="col-12">
                    {{ form.description|as_crispy_field }}
                  </div>
                </div>
              </div>

              <!-- Attachment Section -->
              <div class="form-section">
                <h6 class="section-title">
                  <i class="bi bi-paperclip me-2"></i>Supporting Evidence
                </h6>
                <div class="row g-3">
                  <div class="col-12">
                    {{ form.attachment|as_crispy_field }}
                  </div>
                </div>
              </div>

              {% if form.non_field_errors %}
                <div class="alert alert-danger" role="alert">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  {% for error in form.non_field_errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}

              <!-- Form Actions -->
              <div class="form-actions mt-4 pt-4 border-top">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                  <div class="form-note">
                    <small class="text-muted">
                      <i class="bi bi-shield-check me-1"></i>
                      All reports are confidential and reviewed by security staff
                    </small>
                  </div>
                  <div class="button-group d-flex gap-2">
                    <a class="btn btn-outline-secondary" href="{% url 'incidents:my_incidents' %}">
                      <i class="bi bi-x-lg me-2"></i>Cancel
                    </a>
                    <button class="btn btn-danger" type="submit">
                      <i class="bi bi-send me-2"></i>Submit Report
                    </button>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Sidebar Column -->
      <div class="col-lg-4">
        <!-- Guidelines Card -->
        <div class="card guidelines-card shadow-sm mb-4">
          <div class="card-body">
            <h6 class="mb-3">
              <i class="bi bi-lightbulb-fill text-warning me-2"></i>Reporting Guidelines
            </h6>
            <ul class="guidelines-list">
              <li>Provide a clear, descriptive title</li>
              <li>Select the appropriate severity level</li>
              <li>Include specific date and time</li>
              <li>Describe what happened in detail</li>
              <li>Attach photos or documents if available</li>
              <li>Include witness information if relevant</li>
            </ul>
          </div>
        </div>

        <!-- Severity Guide Card -->
        <div class="card severity-card shadow-sm mb-4">
          <div class="card-body">
            <h6 class="mb-3">
              <i class="bi bi-flag-fill text-danger me-2"></i>Severity Levels
            </h6>
            <div class="severity-guide">
              <div class="severity-item">
                <span class="severity-badge severity-critical">Critical</span>
                <p class="small mb-0 mt-1">Immediate threat to life or property</p>
              </div>
              <div class="severity-item">
                <span class="severity-badge severity-high">High</span>
                <p class="small mb-0 mt-1">Serious security breach or threat</p>
              </div>
              <div class="severity-item">
                <span class="severity-badge severity-medium">Medium</span>
                <p class="small mb-0 mt-1">Notable concern requiring attention</p>
              </div>
              <div class="severity-item">
                <span class="severity-badge severity-low">Low</span>
                <p class="small mb-0 mt-1">Minor issue or observation</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Emergency Contact Card -->
        <div class="card emergency-card shadow-sm">
          <div class="card-body">
            <h6 class="mb-3">
              <i class="bi bi-telephone-fill text-danger me-2"></i>Emergency Contacts
            </h6>
            <div class="emergency-info">
              <div class="emergency-item">
                <strong>Security Emergency:</strong>
                <a href="tel:911" class="text-danger fw-bold">911</a>
              </div>
              <div class="emergency-item">
                <strong>UN Security:</strong>
                <a href="tel:212-963-5555" class="text-primary">212-963-5555</a>
              </div>
              <div class="emergency-item">
                <strong>Medical Emergency:</strong>
                <a href="tel:212-963-3333" class="text-primary">212-963-3333</a>
              </div>
            </div>
            <div class="alert alert-warning mt-3 mb-0 py-2 px-3">
              <small class="mb-0">
                <strong>For immediate emergencies, call directly rather than submitting a report.</strong>
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Layout & Container */
  .incident-report-container {
    background-color: #f8f9fa;
    min-height: 100vh;
  }

  /* Page Header */
  .page-header {
    background: white;
    padding: 1.5rem;
    border-radius: 0.75rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }

  .page-title {
    font-size: 1.75rem;
    font-weight: 600;
    color: #212529;
    margin: 0;
  }

  .breadcrumb {
    font-size: 0.875rem;
  }

  .breadcrumb-item a {
    color: #6c757d;
    text-decoration: none;
  }

  .breadcrumb-item a:hover {
    color: #0d6efd;
  }

  /* Cards */
  .card {
    border: none;
    border-radius: 0.75rem;
    overflow: hidden;
  }

  .form-card {
    border: 2px solid #e9ecef;
  }

  .card-header {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    border: none;
    padding: 1rem 1.5rem;
  }

  .card-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: white;
  }

  /* Form Sections */
  .form-section {
    margin-bottom: 2rem;
  }

  .form-section:last-of-type {
    margin-bottom: 0;
  }

  .section-title {
    color: #495057;
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 1.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #e9ecef;
    display: flex;
    align-items: center;
  }

  .section-title i {
    color: #dc3545;
  }

  /* Crispy Forms Styling Override */
  .form-section label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
  }

  .form-section .form-control,
  .form-section .form-select {
    border: 2px solid #e9ecef;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.2s ease;
  }

  .form-section .form-control:focus,
  .form-section .form-select:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.15);
    outline: none;
  }

  .form-section textarea.form-control {
    resize: vertical;
    min-height: 120px;
  }

  .form-section .invalid-feedback {
    display: block;
    font-size: 0.875rem;
    color: #dc3545;
    margin-top: 0.375rem;
    font-weight: 500;
  }

  .form-section .form-text {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 0.375rem;
  }

  .form-section .mb-3 {
    margin-bottom: 0 !important;
  }

  /* Form Actions */
  .form-actions {
    background: #f8f9fa;
    margin: 0 -1.5rem -1.5rem;
    padding: 1.5rem;
    border-radius: 0 0 0.75rem 0.75rem;
  }

  .form-note {
    font-size: 0.875rem;
  }

  /* Alert */
  .alert-info {
    background: #e3f2fd;
    border: 2px solid #90caf9;
    border-radius: 0.75rem;
  }

  .alert-info .alert-icon {
    color: #1976d2;
  }

  .alert-info .alert-heading {
    color: #0d47a1;
    font-size: 1rem;
  }

  /* Guidelines Card */
  .guidelines-card {
    border: 2px solid #e9ecef;
  }

  .guidelines-card h6 {
    color: #495057;
    font-weight: 600;
  }

  .guidelines-list {
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: 0.9rem;
    color: #495057;
  }

  .guidelines-list li {
    padding: 0.5rem 0;
    padding-left: 1.5rem;
    position: relative;
    border-bottom: 1px solid #f0f0f0;
  }

  .guidelines-list li:last-child {
    border-bottom: none;
  }

  .guidelines-list li::before {
    content: "✓";
    position: absolute;
    left: 0;
    color: #28a745;
    font-weight: bold;
    font-size: 1rem;
  }

  /* Severity Card */
  .severity-card {
    border: 2px solid #e9ecef;
  }

  .severity-card h6 {
    color: #495057;
    font-weight: 600;
  }

  .severity-guide {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .severity-item {
    padding-bottom: 1rem;
    border-bottom: 1px solid #f0f0f0;
  }

  .severity-item:last-child {
    padding-bottom: 0;
    border-bottom: none;
  }

  .severity-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .severity-critical {
    background: #fee;
    color: #c00;
  }

  .severity-high {
    background: #fff3cd;
    color: #856404;
  }

  .severity-medium {
    background: #d1ecf1;
    color: #0c5460;
  }

  .severity-low {
    background: #e2e3e5;
    color: #383d41;
  }

  /* Emergency Card */
  .emergency-card {
    background: linear-gradient(135deg, #fee 0%, #fdd 100%);
    border: 2px solid #fcc;
  }

  .emergency-card h6 {
    color: #c00;
    font-weight: 600;
  }

  .emergency-info {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .emergency-item {
    font-size: 0.9rem;
    color: #495057;
  }

  .emergency-item strong {
    display: block;
    margin-bottom: 0.25rem;
    color: #212529;
  }

  .emergency-item a {
    text-decoration: none;
    font-size: 1.1rem;
  }

  /* Buttons */
  .btn {
    font-weight: 500;
    padding: 0.625rem 1.25rem;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
    border-width: 2px;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .btn:active {
    transform: translateY(0);
  }

  .btn-danger {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    border-color: #dc3545;
  }

  .btn-danger:hover {
    background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
    border-color: #bd2130;
  }

  .btn-outline-secondary {
    color: #6c757d;
    border-color: #6c757d;
  }

  .btn-outline-secondary:hover {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
  }

  /* Responsive Design */
  @media (max-width: 991px) {
    .page-title {
      font-size: 1.5rem;
    }
  }

  @media (max-width: 767px) {
    .form-actions {
      padding: 1rem;
    }

    .form-actions .d-flex {
      flex-direction: column;
      align-items: stretch !important;
    }

    .button-group {
      width: 100%;
    }

    .button-group .btn {
      flex: 1;
    }

    .form-note {
      text-align: center;
      width: 100%;
      margin-bottom: 0.5rem;
    }
  }

  /* Animation */
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .form-card {
    animation: slideIn 0.3s ease-out;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Form validation enhancement
    const form = document.getElementById('incidentForm');

    if (form) {
      form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      });

      // Real-time validation
      const inputs = form.querySelectorAll('input, select, textarea');
      inputs.forEach(function(input) {
        input.addEventListener('blur', function() {
          if (input.hasAttribute('required') && !input.value) {
            input.classList.add('is-invalid');
          } else {
            input.classList.remove('is-invalid');
          }
        });

        input.addEventListener('input', function() {
          if (input.classList.contains('is-invalid') && input.value) {
            input.classList.remove('is-invalid');
          }
        });
      });
    }

    // Auto-dismiss alerts
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(function(alert) {
      if (!alert.classList.contains('alert-info') && !alert.classList.contains('alert-warning')) {
        setTimeout(function() {
          const bsAlert = new bootstrap.Alert(alert);
          bsAlert.close();
        }, 5000);
      }
    });

    // File input enhancement
    const fileInput = document.querySelector('input[type="file"]');
    if (fileInput) {
      fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
          const fileName = this.files[0].name;
          const fileSize = (this.files[0].size / 1024 / 1024).toFixed(2);
          console.log(`Selected: ${fileName} (${fileSize} MB)`);
        }
      });
    }
  });
</script>
{% endblock %}